# Generated by `rjournal_pdf_article()` using `knitr::purl()`: do not edit by hand
# Please edit chassagnol-becht-nuel-benchmark-of-Gaussian-mixtures.Rmd to modify this file

## ----setup, include=FALSE-----------------------------------------------------
knitr::opts_chunk$set(
	echo = FALSE,
	warning = FALSE, 
	message = FALSE,
	fig.align = "center",
	fig.cap.pre = "Figure ",
	fig.cap.sep = ": ",
	message = FALSE,
	warning = FALSE,
	out.width = "100%",
	tab.cap.pre = "Table ",
	tab.cap.sep = ": ",
	fig.cap.pre = "Figure ",
	fig.cap.sep = ": ",
	fig.fullwidth=TRUE,
	fig.pos = "h")

library(ggplot2)
library(dplyr)
library(flextable)
library(kableExtra)
library(downlit)
library(RGMMBench)

options(dplyr.summarise.inform = FALSE) # remove the override .groups argument

# rjtools::initial_check_article(".", dic = "en_GB", ignore=c("gmms", "transcriptomic", "gaussian", "heteroscedascity", "equi", "clusterwise", "underbrace", "homoscedascity", "rebmix", "cran", "bioconductor", "mclust", "kd", "st", "th", "homoscedastic", "hyperparameters"))


## p.caption {

##   font-size: 0.6em;

## }

## 

## .blackbox {

##   padding: 1em;

##   background: #DBDBDB;

##   color: black;

##   border: 4px solid black;

##   border-radius: 10px;

## }

## .center {

##   text-align: center;

## }

## 

## .cols {display: flex; }


## ----flowchart, fig.cap="A minimal roadmap used for the selection of the packages reviewed in our benchmark.", fig.alt="From root to top, we describe schematically the filtering process used for the final selection of the reviewed packages"----
knitr::include_graphics("figs/flowchart_packages_selection.png")


## ----low-comparison-package-html, layout="l-body-outset", eval = knitr::is_html_output()----
#> readr::read_delim("./tables/package_comparison_low_level.csv", delim=";", show_col_types = F) %>%
#>   mutate(Imports=stringr::str_replace(Imports, ">=", "\U2265"),
#>          dplyr::across(.cols = c("Regression", "Implemented models"), ~ gsub(pattern = "redcross", "./figs/red_cross.png", .x)),
#>          dplyr::across(.cols = c("Regression", "Implemented models"), ~ gsub(pattern = "greentick", "./figs/green_tick.png", .x)),
#>          across(.cols = where(is.character), stringr::str_replace_all, "\\\\n", " ")) %>%
#>   flextable() %>%
#>   flextable::mk_par(i = 1:7, j = 3, value = as_paragraph(
#>     flextable::as_image(src = Regression, width = 0.5, height = 0.5, unit = "cm"))) %>%
#>   flextable::mk_par( i = c(1, 4:7), j = 4, value = as_paragraph(
#>     flextable::as_image(src = "./figs/red_cross.png", width = 0.5, height = 0.5, unit = "cm"))) %>%
#>   set_caption(caption = "Main features of the reviewed packages, sorted by decreasing number
#> of daily downloads. *Downloads per day* returns the daily average number of downloads for each package on the last 2 years.
#>  *Recursive dependencies* column counts the complete set of non-base packages required, as first-order dependencies
#>                     may require as well installation of other packages.", html_escape = F) %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%   flextable::autofit()


## ----low-comparison-package-pdf, eval = knitr::is_latex_output()--------------
readr::read_delim("./tables/package_comparison_low_level.csv", delim=";", show_col_types = F) %>%
  mutate(dplyr::across(.cols = c("Regression", "Implemented models"), ~ gsub(pattern = "redcross", "$\\\\redcross$", .x)),
         dplyr::across(.cols = c("Regression", "Implemented models"), ~ gsub(pattern = "greentick", "\\\\greentick", .x)),
         Imports= gsub(pattern = ">=", "$\\\\ge$", Imports),
         across(.cols = where(is.character),kableExtra::linebreak,  linebreaker = "\\\\n")) %>%
  kbl(booktabs=T, caption = "Main features of the reviewed packages, sorted by decreasing number of daily downloads.
               \\textit{Downloads per day} returns the daily average number of downloads for each package on the last 2 years.
               \\textit{Recursive dependencies} column counts the complete set of non-base packages required,
               as first-order dependencies may require as well installation of other packages.", escape=F,
      col.names = linebreak(c("Package", "Version",
                              "Regression", "Implemented \n models", "Downloads \n per day",
                              "Last \n update", "Imports", "Recursive \n dependencies", "Language"))) %>%
  row_spec(0,bold=T, align = "c", hline_after = T) %>%
  row_spec(1:7, hline_after = T, align = "c") %>%
  column_spec(column = 1:9, latex_valign = "m") %>%
  kable_styling(latex_options=c("hold_position", "scale_down"))


## ----high-comparison-packages-html, layout="l-body-outset", eval = knitr::is_html_output()----
#> data <- readr::read_delim("./tables/package_comparison_high_level.csv", delim=";", show_col_types = F) %>%
#>   filter(!(Column1 %in% c("Labelled data", "Weighted implementation"))) %>%
#>   tibble::column_to_rownames("Column1") %>%
#>   mutate(dplyr::across(.cols = everything(), ~ gsub(pattern = "redcross", "./figs/red_cross.png", .x)),
#>          dplyr::across(.cols = everything(), ~ gsub(pattern = "greentick", "./figs/green_tick.png", .x)))
#> 
#> data %>% flextable() %>%
#>   flextable::mk_par(i = "Bootstrap Confidence Intervals", value = as_paragraph(
#>     flextable::as_image(src = data["Bootstrap Confidence Intervals", ] %>% unlist(), width = 0.5, height = 0.5, unit = "cm")))%>%
#>   flextable::mk_par( j = grep("red_cross", data["Model or Cluster selection", ]),
#>                      i = "Model or Cluster Selection", value = as_paragraph(
#>                        flextable::as_image(src = "./figs/red_cross.png", width = 0.5, height = 0.5, unit = "cm"))) %>%
#>   flextable::mk_par(j=grep("red_cross", data["Variants of the EM algorithm", ]) %>% unlist(),
#>                     i = "Variants of the EM algorithm", value = as_paragraph(
#>                       flextable::as_image(src = "./figs/red_cross.png", width = 0.5, height = 0.5, unit = "cm"))) %>%
#>   flextable::mk_par(j=grep("red_cross", data["Visualisation", ]) %>% unlist(),
#>                     i = "Visualisation", value = as_paragraph(
#>                       flextable::as_image(src = "./figs/red_cross.png", width = 0.5, height = 0.5, unit = "cm"))) %>%
#>   set_caption(caption = "Custom features associated to GMMs estimation for any of the benchmarked packages.",
#>               html_escape = F) %>%
#>   theme_vanilla() %>%
#>   align(align = "center", part = "header") %>%  # centre align header
#>   flextable::autofit()


## ----high-comparison-packages-pdf, eval = knitr::is_latex_output()------------
readr::read_delim("./tables/package_comparison_high_level.csv", delim=";", show_col_types = F) %>%
  filter(!(Column1 %in% c("Labelled data", "Weighted implementation"))) %>%
  tibble::column_to_rownames("Column1") %>%
  mutate(dplyr::across(.cols = everything(), ~ gsub(pattern = "redcross", "\\\\redcross", .x)),
         dplyr::across(.cols = everything(), ~ gsub(pattern = "greentick", "\\\\greentick", .x))) %>%
  kbl(booktabs=T, caption = "Custom features associated to GMMs estimation for any of the benchmarked packages.", escape=F) %>%
  kable_styling(latex_options=c("hold_position", "scale_down")) %>%
  row_spec(0,bold=T, align = "c") %>%
  row_spec(1:7, hline_after = T) %>%
  column_spec(column = 1:8, latex_valign = "m", width = c("2.4cm", "4cm", rep("2.4cm", 6))) %>%
  column_spec(column = 1, bold=T, border_right = T)


## ----general-parameter-description-html, eval=knitr::is_html_output()---------
#> read.table("./tables/general_simulation_parameters.csv", sep = ";", header = T, check.names = F) %>%
#>   flextable() %>%
#>   compose(j = "Criterion threshold", value = as_paragraph(as_equation(`Criterion threshold`, width = 2, height = .5))) %>%
#>   set_caption(caption = "Global options shared by all the benchmarked packages.", html_escape = F) %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%   flextable::autofit()


## ----general-parameter-description-pdf, eval=knitr::is_latex_output()---------
formatted_data <- readr::read_delim("./tables/general_simulation_parameters.csv", delim=";") %>%
  dplyr::mutate(`Criterion threshold`=paste0("$", `Criterion threshold`, "$"))


formatted_data %>% kbl(booktabs=T, caption = "Global options shared by all the benchmarked packages.", escape=F, midrule="midrule", align = "c") %>%
  kable_styling(latex_options=c("hold_position", "scale_down")) %>%
  row_spec(0,bold=T) %>%
  row_spec(1, hline_after = T) %>%
  column_spec(1:ncol(formatted_data), width = "4.1cm") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


## ----prepare-data-------------------------------------------------------------
#################################################################
##         prepare univariate scores and distributions         ##
#################################################################
univariate_distribution_parameters <- readRDS("./tables/univariate/univariate_distributions.rds") %>%
  dplyr::group_by(ID, package, initialisation_method) %>%
  dplyr::mutate(N.bootstrap=dplyr::row_number()) %>% dplyr::ungroup()
univariate_time_computation <- readRDS("./tables/univariate/univariate_time_computation.rds")
univariate_configuration <- readRDS("./tables/univariate/univariate_configuration_scenario.rds")

formatted_univariate_distribution_parameters <- univariate_distribution_parameters %>%
  rename_with(~gsub("^sd", "sigma", .x)) %>%
  mutate(color=dplyr::if_else(package %in% c("RGMMBench", "Rmixmod", "mixtools"), 'red', 'green'),
         package=dplyr::if_else(package %in% c("flexmix", "mclust", "mixtools"),
                                glue::glue("<b style='color:{color}; font-size:22pt'>{package}</b>"),
                                glue::glue("<p style='color:{color}'>{package}</p>")))

univariate_parameters_local_scores <- readRDS("./tables/univariate/univariate_local_scores.rds") %>%
  filter(package %in% c("mixtools", "Rmixmod", "mclust", "EMCluster", "flexmix")) %>%
  mutate(package=forcats::fct_recode(package, `Rmixmod / RGMMBench`="Rmixmod", `mclust / bgmm`="mclust", `EMCluster / GMKMcharlie`="EMCluster"))

univariate_parameters_local_scores_summary <- univariate_parameters_local_scores %>% dplyr::filter(scores=="mse") %>%
  rowwise() %>% mutate(global_mse_p = sum(c(p1, p2, p3, p4)),
                       global_mse_mu = sum(c(mu1, mu2, mu3, mu4)),
                       global_mse_sigma=sum(c(sigma1, sigma2, sigma3, sigma4))) %>%
  dplyr::group_by(ID, initialisation_method, package) %>%
  dplyr::summarise(global_mse_p=mean(global_mse_p), global_mse_mu=mean(global_mse_mu), global_mse_sigma=mean(global_mse_sigma)) %>%
  dplyr::inner_join(univariate_parameters_local_scores %>% dplyr::filter(scores=="bias") %>%
                      rowwise() %>% mutate(global_bias_p = sum(abs(c(p1, p2, p3, p4))),
                                           global_bias_mu = sum(abs(c(mu1, mu2, mu3, mu4))),
                                           global_bias_sigma=sum(abs(c(sigma1, sigma2, sigma3, sigma4)))) %>%
                      dplyr::group_by(ID, initialisation_method, package) %>%
                      dplyr::summarise(global_bias_p=mean(global_bias_p), global_bias_mu=mean(global_bias_mu), global_bias_sigma=mean(global_bias_sigma))) %>%
  dplyr::arrange(ID, package, initialisation_method) %>%
  dplyr::relocate(initialisation_method, .after = package) %>%
  dplyr::rename(Package=package, `Initialisation Method`=initialisation_method) %>%
  mutate(across(where(is.numeric), ~format(.x, digits=2, nsmall=0, ) %>% as.numeric)) %>% dplyr::ungroup()


#################################################################
##        prepare multivariate scores and distributions        ##
#################################################################

multivariate_distribution_parameters <- readRDS("./tables/multivariate/bivariate_distributions.rds")%>%
  dplyr::group_by(ID, package, initialisation_method) %>%
  dplyr::mutate(N.bootstrap=dplyr::row_number()) %>% dplyr::ungroup()
multivariate_time_computations <- readRDS("./tables/multivariate/bivariate_time_computation.rds")
multivariate_configuration <- readRDS("./tables/multivariate/bivariate_configuration_scenario.rds")

formatted_multivariate_distribution_parameters <- multivariate_distribution_parameters %>%
  mutate(color=dplyr::if_else(package %in% c("RGMMBench", "Rmixmod", "mixtools"), 'red', 'green'),
         package=dplyr::if_else(package %in% c("flexmix", "mclust", "mixtools"),
                                glue::glue("<b style='color:{color}; font-size:22pt'>{package}</b>"),
                                glue::glue("<p style='color:{color}'>{package}</p>")))


multivariate_parameters_local_scores <- readRDS("./tables/multivariate/bivariate_local_scores.rds") %>%
  filter(package %in% c("mixtools", "Rmixmod", "mclust", "EMCluster", "flexmix")) %>%
  mutate(package=forcats::fct_recode(package, `Rmixmod / RGMMBench`="Rmixmod", `mclust / bgmm`="mclust", `EMCluster / GMKMcharlie`="EMCluster"))

multivariate_parameters_local_scores_summary <- multivariate_parameters_local_scores %>% dplyr::filter(scores=="mse") %>%
  rowwise() %>% mutate(global_mse_p = sum(dplyr::c_across(dplyr::matches("p[[:digit:]]+"))),
                       global_mse_mu = sum(dplyr::c_across(dplyr::matches("mu"))),
                       global_mse_sigma=sum(dplyr::c_across(dplyr::matches("sd")))) %>%
  dplyr::group_by(ID, initialisation_method, package) %>%
  dplyr::summarise(global_mse_p=mean(global_mse_p), global_mse_mu=mean(global_mse_mu), global_mse_sigma=mean(global_mse_sigma)) %>%
  dplyr::inner_join(multivariate_parameters_local_scores %>% dplyr::filter(scores=="bias") %>%
                      rowwise() %>% mutate(global_bias_p = sum(abs(dplyr::c_across(dplyr::matches("p[[:digit:]]+")))),
                                           global_bias_mu = sum(abs(dplyr::c_across(dplyr::matches("mu")))),
                                           global_bias_sigma=sum(abs(dplyr::c_across(dplyr::matches("sd"))))) %>%
                      dplyr::group_by(ID, initialisation_method, package) %>%
                      dplyr::summarise(global_bias_p=mean(global_bias_p), global_bias_mu=mean(global_bias_mu), global_bias_sigma=mean(global_bias_sigma))) %>%
  dplyr::arrange(ID, package, initialisation_method) %>%
  dplyr::relocate(initialisation_method, .after = package) %>%
  dplyr::rename(Package=package, `Initialisation Method`=initialisation_method) %>%
  mutate(across(where(is.numeric), ~format(.x, digits=2, nsmall=0, ) %>% as.numeric)) %>% ungroup()
metric_colnames <- c("global_mse_p", "global_mse_mu", "global_mse_sigma", "global_bias_p", "global_bias_mu", "global_bias_sigma")


## ----prepare-legend-final-figure----------------------------------------------
html_ouput <- knitr::is_html_output()  
html_final_legend <- paste("Panels A and B show respectively the heatmap of the Pearson correlation in the univariate and in the multivariate setting between the parameters estimated across the evaluated packages. The correlation matrix was computed using the function", downlit::autolink('stats::cor'), "with option *complete* to remove any missing value related to a failed simulation, and the heatmap generated with the Bioconductor package \\BIOpkg{Complexheatmap}.

Panel C represents a tree summarising the main differences between the benchmarked packages, in terms of the EM implementation. They are discussed in more detail in Appendix [EM-implementation differences across reviewed packages].")

pdf_final_legend <- "Panels A and B show respectively the heatmap of the Pearson correlation in the univariate and in the multivariate setting between the parameters estimated across the evaluated packages. The correlation matrix was computed using the function \\code{stats::cor} with option \\textit{complete} to remove any missing value related to a failed simulation, and the heatmap generated with the Bioconductor package \\BIOpkg{Complexheatmap}. Panel C represents a tree summarising the main differences between the benchmarked packages, in terms of the EM implementation. They are discussed in more detail in Appendix \\nameref{sec:em-differences}."


## ----dichotomy-package-conclusion, fig.cap=if (html_ouput) html_final_legend else pdf_final_legend----

knitr::include_graphics("./figs/dichotomy_package_conclusion.png")


## ----decision-tree-GMMs, fig.cap="A decision tree to select the best combination of package and initialisation method with respect to the main characteristics of the mixture. It's worth pointing that in both univariate and low dimension multivariate settings, the recommandations are similar."----

# decision_tree_univariate <- Node$new("Estimation of the MLE in GMMs")
# separated <- decision_tree_univariate$AddChild("Well-separated components")
# rebmix <- separated$AddChild("Rebmix initialisation")
# overlapping <- decision_tree_univariate$AddChild("Overlapping components")
# balanced <- overlapping$AddChild("Balanced mixture")
# kmeans_balanced <- balanced$AddChild("*k*-means initialisation with \n GMKMcharlie or EMCluster")
# unbalanced_numerous_components <- overlapping$AddChild("Unbalanced and number of clusters \U2265 4")
# unbalanced_variability <- unbalanced_numerous_components$AddChild("Optimise variability and MSE")
# second_class <- unbalanced_variability$AddChild("Second class of packages \n with *k*-means initialisation, \n preferentially with GMKMcharlie \n or EMCluster")
# unbalanced_bias <- unbalanced_numerous_components$AddChild("Optimise bias")
# first_class <- unbalanced_bias$AddChild("First class of packages \n with *k*-means initialization \n for proportions and variability \n estimations and random \n for centroids estimation")
# unbalanced_few_components <- overlapping$AddChild("Unbalanced and number of clusters < 4")
# decision_unbalanced_few_components <- unbalanced_few_components$AddChild("rebmix or random initialisation \n with the second class of packages.")
#
# # custom the decision tree plot
# SetGraphStyle(decision_tree_univariate, rankdir = "TB", fontSize = 25)
# SetEdgeStyle(decision_tree_univariate, arrowhead = "vee", penwidth = 2)
# SetNodeStyle(decision_tree_univariate, style = "filled,rounded", shape = "box",
#              fontname = "helvetica", tooltip = GetDefaultTooltip)
# # SetNodeStyle(separated, fillcolor = "chartreuse1")
# # SetNodeStyle(overlapping, fillcolor = "crimson")
# Do(decision_tree_univariate$leaves, function(node) SetNodeStyle(node, shape = "egg")) # custom the leaves
#
#
# DiagrammeR::export_graph(ToDiagrammeRGraph(decision_tree_univariate),
#                          "./figs/decision_tree.png", file_type = "png")


knitr::include_graphics("./figs/decision_tree_GMMs.png")


## ----summary-em-html, layout="l-body-outset", eval = knitr::is_html_output()----
#> data <- readr::read_delim("./tables/summary_em_estimation.csv", delim=";", show_col_types = F) %>%
#>   tibble::column_to_rownames("Column1")
#> 
#> 
#> data %>% flextable() %>%
#>   flextable::mk_par(j="Univariate GMM",
#>                     value = as_paragraph(as_equation(`Univariate GMM`, width = 10, height = 2, unit = "cm"))) %>%
#>   flextable::mk_par(j="Multivariate GMM",
#>                     value = as_paragraph(as_equation(`Multivariate GMM`, width = 10, height = 2, unit = "cm"))) %>%
#>   merge_at(i = 2, j = 1:2) %>%
#>   set_caption(caption = "An overview of the practical implementation of the EM algorithm in GMMs.",html_escape = F) %>%
#>   theme_vanilla() %>%
#>   align(align = "center", part = "header") %>%  # centre align header
#>   flextable::autofit()
#> 


## ----summary-em-pdf,  eval = knitr::is_latex_output()-------------------------
readr::read_delim("./tables/summary_em_estimation.csv", delim=";", show_col_types = F) %>%
  tibble::column_to_rownames("Column1") %>%
  mutate(dplyr::across(.cols = c("Univariate GMM", "Multivariate GMM"), ~ paste0("$", .x, "$"))) %>%
  kbl(booktabs=T, caption = "An overview of the practical implementation of the EM algorithm in GMMs.", escape=F) %>%
  kable_styling(latex_options=c("hold_position", "scale_down")) %>%
  row_spec(0,bold=T, align = "c") %>%
  row_spec(1:3, hline_after = T, align = "c") %>%
  column_spec(column = 1:3, width = rep("6.8cm", 3), latex_valign = "m") %>%
  column_spec(column = 1:2,  border_right = T)


## ----param-multivariate-gaussian----------------------------------------------
data <- readr::read_delim("./tables/parametrisation_multivariate_gaussian.csv", delim=",", show_col_types = F) %>%
  mutate(Representation="",
         dplyr::across(.cols = c("Notation", "Number of parameters"), ~ paste0("$", .x, "$")))
Representation <- file.path("./tables", "gaussian_param",paste0(data$Model, ".png"))


data %>% kbl(booktabs=T, caption = "The 14 canonical parametrisations of the within-group covariance matrix $\\boldsymbol{\\Sigma_j}$ with the corresponding geometric representations.", escape=F) %>%
  kable_styling(latex_options=c("scale_down"), font_size = 7) %>%
  row_spec(0,bold=T, align = "c") %>%
  row_spec(1:14, align = "c", hline_after = T) %>%
  column_spec(6, image=spec_image(Representation, 400, 235, res=600)) %>%
  column_spec(column = 1:6, width = c("2cm", "3cm", "3cm", "2cm", "4.5cm", "5cm"), latex_valign = "m")


## ----generate-overlap-plot-univariate-----------------------------------------
temp_simu <- tibble::tibble(x=seq(0, 15, length.out = 1000))
true_theta <- list(p=c(0.5, 0.5), mu=c(5.28, 8.45), sigma=c(1, 3),skew=c(0,0))
for (i in 1:2) {
  temp_simu <- temp_simu %>% tibble::add_column("component {i}" := true_theta$p[i] *
                                                  sn::dsn(temp_simu$x, xi=true_theta$mu[i], omega = true_theta$sigma[i], alpha = true_theta$skew[i], tau=0))
}
temp_simu <- temp_simu %>% dplyr::mutate(total=rowSums(dplyr::across(dplyr::starts_with("component ")))) %>%
  tidyr::pivot_longer(cols =dplyr::starts_with(c("component ", "total")), names_to = "components", values_to = "y")

roots <- compute_overlap_roots(0.5, 0.5, 5.28, 8.45, 1,3)
overlap_plot_pairwise_balanced_1 <- ggplot(temp_simu, aes(x = x, color = gsub("component ", "", components), y=y,linetype=gsub("component ", "", components))) +
  geom_line(size=1) +
  theme_bw() +
  theme(plot.title = element_blank(), legend.position = "bottom", axis.title=element_blank(),
        legend.key.width = unit(1.5, 'cm'), legend.text = element_text(size=14),
        plot.subtitle = element_blank(), legend.title = element_blank(), plot.tag = element_text(size=16, face = "bold")) +
  scale_linetype_manual(values = c(2, 3, 1)) +
  geom_vline(xintercept=roots, color="red", linetype="dashed", size=1.15) +
  geom_area(data = dplyr::filter(temp_simu, x>max(roots) & components=="component 1"), fill = '#FDC086',show.legend = F) +
  geom_area(data = dplyr::filter(temp_simu, x <min(roots) & components=="component 1"), fill = '#FDC086',show.legend = F) +
  geom_area(data = dplyr::filter(temp_simu, x<max(roots) & x >min(roots) & components=="component 2"), fill = '#7FC97F',show.legend = F) +
  labs(tag="A")



temp_simu <- tibble::tibble(x=seq(0, 15, length.out = 1000))
true_theta <- list(p=c(0.9, 0.1), mu=c(5.28, 8.45), sigma=c(1, 3),skew=c(0,0))
for (i in 1:2) {
  temp_simu <- temp_simu %>% tibble::add_column("component {i}" := true_theta$p[i] *
                                                  sn::dsn(temp_simu$x, xi=true_theta$mu[i], omega = true_theta$sigma[i], alpha = true_theta$skew[i], tau=0))
}
temp_simu <- temp_simu %>% dplyr::mutate(total=rowSums(dplyr::across(dplyr::starts_with("component ")))) %>%
  tidyr::pivot_longer(cols =dplyr::starts_with(c("component ", "total")), names_to = "components", values_to = "y")
roots <- compute_overlap_roots(0.9, 0.1, 5.28, 8.45, 1,3)
overlap_plot_pairwise_balanced_2 <- ggplot(temp_simu, aes(x = x, color = gsub("component ", "", components), y=y,linetype=gsub("component ", "", components))) +
  geom_line(size=1) +
  theme_bw() +
  theme(plot.title = element_blank(), legend.position = "bottom", axis.title=element_blank(),
        legend.key.width = unit(1.5, 'cm'), legend.text = element_text(size=14),
        plot.subtitle = element_blank(), legend.title = element_blank(), plot.tag = element_text(size=16, face = "bold")) +
  scale_linetype_manual(values = c(2, 3, 1)) +
  geom_vline(xintercept=roots, color="red", linetype="dashed", size=1.15) +
  geom_area(data = dplyr::filter(temp_simu, x>max(roots) & components=="component 1"), fill = '#FDC086',show.legend = F) +
  geom_area(data = dplyr::filter(temp_simu, x <min(roots) & components=="component 1"), fill = '#FDC086',show.legend = F) +
  geom_area(data = dplyr::filter(temp_simu, x<max(roots) & x >min(roots) & components=="component 2"), fill = '#7FC97F',show.legend = F) +
  labs(tag="B")



temp_simu <- tibble::tibble(x=seq(0, 15, length.out = 1000))
true_theta <- list(p=c(0.5, 0.5), mu=c(5.28, 8.45), sigma=c(3, 1),skew=c(0,0))
for (i in 1:2) {
  temp_simu <- temp_simu %>% tibble::add_column("component {i}" := true_theta$p[i] *
                                                  sn::dsn(temp_simu$x, xi=true_theta$mu[i], omega = true_theta$sigma[i], alpha = true_theta$skew[i], tau=0))
}
temp_simu <- temp_simu %>% dplyr::mutate(total=rowSums(dplyr::across(dplyr::starts_with("component ")))) %>%
  tidyr::pivot_longer(cols =dplyr::starts_with(c("component ", "total")), names_to = "components", values_to = "y")
roots <- compute_overlap_roots(0.5, 0.5, 5.28, 8.45, 3, 1)
overlap_plot_pairwise_balanced_3 <- ggplot(temp_simu, aes(x = x, color = gsub("component ", "", components), y=y,linetype=gsub("component ", "", components))) +
  geom_line(size=1) +
  theme_bw() +
  theme(plot.title = element_blank(), legend.position = "bottom", axis.title=element_blank(),
        legend.key.width = unit(1.5, 'cm'), legend.text = element_text(size=14),
        plot.subtitle = element_blank(), legend.title = element_blank(), plot.tag = element_text(size=16, face = "bold")) +
  scale_linetype_manual(values = c(2, 3, 1)) +
  geom_vline(xintercept=roots, color="red", linetype="dashed", size=1.15) +
  geom_area(data = dplyr::filter(temp_simu, x>max(roots) & components=="component 1"), fill = '#FDC086',show.legend = F) +
  geom_area(data = dplyr::filter(temp_simu, x <min(roots) & components=="component 1"), fill = '#FDC086',show.legend = F) +
  geom_area(data = dplyr::filter(temp_simu, x<max(roots) & x >min(roots) & components=="component 2"), fill = '#7FC97F',show.legend = F) +
  labs(tag="C")




temp_simu <- tibble::tibble(x=seq(-5, 15, length.out = 1000))
true_theta <- list(p=c(0.9, 0.1), mu=c(5.28, 8.45), sigma=c(3, 1),skew=c(0,0))
for (i in 1:2) {
  temp_simu <- temp_simu %>% tibble::add_column("component {i}" := true_theta$p[i] *
                                                  sn::dsn(temp_simu$x, xi=true_theta$mu[i], omega = true_theta$sigma[i], alpha = true_theta$skew[i], tau=0))
}
temp_simu <- temp_simu %>% dplyr::mutate(total=rowSums(dplyr::across(dplyr::starts_with("component ")))) %>%
  tidyr::pivot_longer(cols =dplyr::starts_with(c("component ", "total")), names_to = "components", values_to = "y")
# roots <- compute_overlap_roots(0.9, 0.1, 5.28, 8.45, 3, 1)
overlap_plot_pairwise_balanced_4 <- ggplot(temp_simu, aes(x = x, color = gsub("component ", "", components), y=y,linetype=gsub("component ", "", components))) +
  geom_line(size=1) +
  theme_bw() +
  theme(plot.title = element_blank(), legend.position = "bottom", axis.title=element_blank(),
        legend.key.width = unit(1.5, 'cm'), legend.text = element_text(size=14),
        plot.subtitle = element_blank(), legend.title = element_blank(), plot.tag = element_text(size=16, face = "bold"))  +
  scale_linetype_manual(values = c(2, 3, 1)) +
  geom_area(data = dplyr::filter(temp_simu, components=="component 2"), fill = '#7FC97F',show.legend = F) +
  labs(tag="D")


## ----OVL-represention-pdf, include=knitr::is_latex_output(), eval=knitr::is_latex_output(), fig.cap="Illustration of the overlaps between a two-components GMM. Density function of component 1 is given by the red line, its of component 2 by the green line, and total density function $f_\\theta(X)$ is represented in blue. The total overlap is given by the sum of the green and red areas."----
gridExtra::grid.arrange(grobs=list(overlap_plot_pairwise_balanced_1, overlap_plot_pairwise_balanced_2,
                                                   overlap_plot_pairwise_balanced_3, overlap_plot_pairwise_balanced_4),
                        top="", ncol=2, nrow=2)


## ----OVL-represention-html, include=knitr::is_html_output(), eval=knitr::is_html_output(), fig.cap="Illustration of the overlaps between a two-components GMM. Density function of component 1 is given by the red line, its of component 2 by the green line, and total density function p<sub>\U03B8</sub>(<i>X</i>) is represented in blue. The total overlap is given by the sum of the green and red areas."----
#> gridExtra::grid.arrange(grobs=list(overlap_plot_pairwise_balanced_1, overlap_plot_pairwise_balanced_2,
#>                                                    overlap_plot_pairwise_balanced_3, overlap_plot_pairwise_balanced_4),
#>                         top="", ncol=2, nrow=2)


## ----outliers, fig.cap="A) Execution times for the nine reviewed packages using hc initialisation, with on the left $2\\%$ of outliers in proportion and on the right, $4\\%$ of outliers.  B) and C) Boxplots of the estimated parameters with $N=200$ repetitions, $n=2000$ observations and respectively $2\\%$ and $4\\%$ of outliers. The red dashed horizontal line corresponds to the true value of the parameters."----
outliers_time_data <- readRDS("./tables/univariate/univariate_outliers_time_computations.rds")
outliers_time_computations <- cowplot::plot_grid(plot_time_computations(outliers_time_data %>% filter(ID=="O1")) +
                                                   labs(tag="A") + theme(plot.tag = element_text(size=18, face = "bold")),
                                                 plot_time_computations(outliers_time_data %>% filter(ID=="O2")) +
                                                   labs(tag="B") + theme(plot.tag = element_text(size=18, face = "bold")),
                                                 ncol = 2, align = 'h', axis="tblr")

outliers_distribution_parameters <- readRDS("./tables/univariate/univariate_outliers_distribution_parameters.rds")
outliers_plot <- gridExtra::arrangeGrob(outliers_time_computations,
                                        plot_boxplots_parameters(outliers_distribution_parameters %>% filter(ID=="O1"),
                                                                 true_theta=list(p=c(0.5, 0.5), mu=c(0, 4), sigma=c(0.3, 0.3)), size_tag=7) +
                                          labs(tag="C")+ theme(plot.tag = element_text(size=18, face = "bold")),
                                        plot_boxplots_parameters(outliers_distribution_parameters %>% filter(ID=="O2"),
                                                                 true_theta=list(p=c(0.5, 0.5), mu=c(0, 4), sigma=c(0.3, 0.3)), size_tag=7) +
                                          labs(tag="D")+ theme(plot.tag = element_text(size=18, face = "bold")),
                                        top="",nrow=3, padding = unit(1, "line"))

ggsave("figs/univariate/outliers.png", outliers_plot, width = 18, height = 24,dpi = 75)
knitr::include_graphics("figs/univariate/outliers.png", dpi = 75)



## ----searched-packages-html, layout="l-body-outset", eval = knitr::is_html_output()----
#> readr::read_delim("./tables/review_packages.csv", delim=";", show_col_types = F) %>%
#>   mutate(`Packages kept`=stringr::str_replace(`Packages kept`, "varnothing", "\U2205"),
#>          across(.cols = where(is.character), stringr::str_replace_all, "\\\\n", ", ")) %>%
#>   rename_with(~ stringr::str_replace_all(.x, "\\\\n", " ")) %>%
#>   flextable() %>%
#>   set_caption(caption = "Meta-analysis summary about the selection of packages implementing the estimation of GMMs,
#>               on CRAN and Bioconductor.", html_escape = F) %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%   flextable::autofit()


## ----searched-packages-pdf, eval = knitr::is_latex_output()-------------------
data <- readr::read_delim("./tables/review_packages.csv", delim=";", show_col_types = F) %>%
  mutate(`Packages kept`=stringr::str_replace(`Packages kept`, "varnothing", "$\\\\varnothing$"),
         across(.cols = where(is.character),kableExtra::linebreak,  linebreaker = "\\\\n"))

data %>% kbl(booktabs=T,
caption = "Meta-analysis summary about the selection of packages implementing the estimation of GMMs,
              on CRAN and Bioconductor.", escape=F, col.names = linebreak(colnames(data), linebreaker = "\\\\n")) %>%
  row_spec(0,bold=T, align = "c", hline_after = T) %>%
  row_spec(1:4, hline_after = T, align = "c") %>%
  column_spec(column = 1:6, latex_valign = "m") %>%
  kable_styling(latex_options=c("hold_position", "scale_down"))


## ----generate-plot-packages-trends--------------------------------------------
downloaded_mixture_packages <- cranlogs::cran_downloads(package = c("mclust", "flexmix","mixtools", "Rmixmod",
                                                                    "EMCluster", "bgmm", "DCEM", "GMKMcharlie"),
                                                        from = "2022-01-01", to = "2022-04-30")
nb_cols <- length(unique(downloaded_mixture_packages$package)) # store graphical parameters
my_colors <- grDevices::colorRampPalette(RColorBrewer::brewer.pal(12, "Paired"))(nb_cols)


download_trends <- ggplot(downloaded_mixture_packages, aes(x=date, y=count, shape=package, colour=package, linetype=package)) +
  geom_line(size=0.5) +
  theme_bw() +
  geom_point(size=1)+
  scale_y_log10(breaks = scales::trans_breaks("log10", function(x) 10^x),
                labels = scales::trans_format("log10", scales::math_format(10^.x))) +
  labs(title=element_blank(),
       x ="Month", y = "Number of daily downloads") +
  scale_shape_manual(values=seq(1,nb_cols)) +
  theme(legend.title = element_blank(), legend.position = "bottom", legend.text = element_text(size=14),
        axis.title=element_text(size=16,face="bold"),
        legend.key.size = unit(1, "cm"), axis.text = element_text(size=12))


## ----trend-package-html, fig.cap="Number of daily downloads (logarithmic scale) from the CRAN mirror from the 1<sup>st</sup> of January to the 30<sup>th</sup>, April 2022 for the seven R packages reviewed.", include=knitr::is_html_output(), eval=knitr::is_html_output()----
#> plotly::ggplotly(download_trends)


## ----trend-package-pdf, fig.height = 5, fig.cap="Number of daily downloads (logarithmic scale) from the CRAN mirror from the $1^\\text{st}$ of January to the $30^{\\text{th}}$ April 2022 for the seven R packages reviewed.", include=knitr::is_latex_output(), eval=knitr::is_latex_output()----
download_trends


## ----parameter-configuration-univariate---------------------------------------
univariate_configuration  %>%   mutate(Proportions=purrr::map_chr(true_parameters, ~paste(.x$p, collapse = " / ")),
                                       Means=purrr::map_chr(true_parameters, ~paste(.x$mu, collapse = " / ")),
                                       Correlations=purrr::map_chr(true_parameters, ~paste(.x$sigma, collapse = " / "))) %>%
  select(-c("OVL", "prop_outliers", "true_parameters", "formatted_true_parameters", "old_OVL")) %>%
  rename(Entropy=entropy, OVL=OVL_pairwise) %>%
  kbl(booktabs=T, caption = "The 9 parameter configurations tested to generate the samples of the univariate experiment, with $k=4$ components.",
      escape=F, align = "c") %>%
  kable_styling(latex_options=c("hold_position", "scale_down")) %>%
  row_spec(0,bold=T) %>% row_spec(1:9, hline_after = T) %>%
  kable_styling(bootstrap_options = c("hover", "condensed"))


## ----prepare-legend-univariate------------------------------------------------
univariate_html_ouput <- knitr::is_html_output()  # change to TRUE for larger figures

html_caption_balanced_well_separated_univariate <- "Benchmark summary plots of scenario U1 in Table \\@ref(tab:parameter-configuration-univariate) (balanced and well-separated components), organised as such:
- The panel A displays the distribution of the global mixture distribution $f_{\\theta}(X)$
(pink solid line) and of each of its constitutive components scaled by
their respective proportions (dotted lines).
- Running times are displayed in Panel B with the *k*-means initialisation. The number of observations
(x-axis) and the running time (y-axis) is in $\\log(10)$ scale, implying
that any linear relationship between the running time and the number of
observations is represented by a slope of 1. The points represent median
running time. The coloured bands represent the 5th and 95th percentiles
of the running time.
- In panel C are represented the boxplots associated with the distribution of the estimates, with one box per pair of package and initialisation method. The median is displayed with bold
black line, the mean with a yellow cross and the 0.25 and 0.95 quantiles
match the edges of the rectangular band. Solid black lines extending
past the box boundaries represent the $1.5$ IQR, estimates above these
limits considered as outliers and omitted from the plot. Finally, the
true value of the parameter is represented as a dashed red line. The bold black writing in the upper right-hand corner refers to the parameter whose distribution is shown in the corresponding facet. The first, second and third rows are the distributions of the ratios, means and variances of each component, identified by the column index."

pdf_caption_balanced_well_separated_univariate <- "Benchmark summary plots of scenario U1 in Table \\ref{tab:parameter-configuration-univariate} (balanced and well-separated components), organised as such:
The panel A displays the distribution of the global mixture distribution $f_{\\theta}(X)$
(pink solid line) and of each of its constitutive components scaled by
their respective proportions (dotted lines).
Running times are displayed in Panel B with the \\textit{k}-means initialisation. The number of observations
(x-axis) and the running time (y-axis) is in $\\log(10)$ scale, implying
that any linear relationship between the running time and the number of
observations is represented by a slope of 1. The points represent median
running time. The coloured bands represent the 5th and 95th percentiles
of the running time.
In panel C are represented the boxplots associated with the distribution of the estimates, with one box per pair of package and initialisation method. The median is displayed with bold
black line, the mean with a yellow cross and the 0.25 and 0.95 quantiles
match the edges of the rectangular band. Solid black lines extending
past the box boundaries represent the $1.5$ IQR, estimates above these
limits considered as outliers and omitted from the plot. Finally, the
true value of the parameter is represented as a dashed red line. The bold black writing in the upper right-hand corner refers to the parameter whose distribution is shown in the corresponding facet. The first, second and third rows are the distributions of the ratios, means and variances of each component, identified by the column index."


html_caption_unbalanced_well_separated_univariate <- "Benchmark summary plots of scenario U7 in Table \\@ref(tab:parameter-configuration-univariate) (unbalanced and well-separated components), with same layout as in Figure \\@ref(fig:four-component-balanced-separated)."
pdf_caption_unbalanced_well_separated_univariate <- "Benchmark summary plots of scenario U7 in Table \\ref{tab:parameter-configuration-univariate} (unbalanced and well-separated components), with same layout as in Figure \\ref{fig:four-component-balanced-separated}."

html_caption_balanced_overlapping_univariate <- "Benchmark summary plots of scenario U3 in Table \\@ref(tab:parameter-configuration-univariate) (balanced and overlapping components), with same layout as in Figure \\@ref(fig:four-component-balanced-separated)."
pdf_caption_balanced_overlapping_univariate <- "Benchmark summary plots of scenario U3 in Table \\ref{tab:parameter-configuration-univariate} (balanced and overlapping components), with same layout as in Figure \\ref{fig:four-component-balanced-separated}."

html_caption_unbalanced_overlapping_univariate <- "Benchmark summary plots of scenario U9 in Table \\@ref(tab:parameter-configuration-univariate) (unbalanced and overlapping components), with same layout as in Figure \\@ref(fig:four-component-balanced-separated)."
pdf_caption_unbalanced_overlapping_univariate <- "Benchmark summary plots of scenario U9 in Table \\ref{tab:parameter-configuration-univariate} (unbalanced and overlapping components), with same layout as in Figure \\ref{fig:four-component-balanced-separated}."

html_caption_intermediate_scenario_univariate <- "Benchmark summary plots of scenarios U4 and U6 in Table \\@ref(tab:parameter-configuration-univariate) (small unbalance, with additional overlap in scenario U6). Panel A and B display the univariate GMM distributions of respectively scenarios U4 and U6, and Panel C and D the benchmarked distributions of respectively scenarios U4 and U6, built as Panel C of Figure \\@ref(fig:four-component-balanced-separated)."
pdf_caption_intermediate_scenario_univariate <- "Benchmark summary plots of scenarios U4 and U6 in Table \\ref{tab:parameter-configuration-univariate} (small unbalance, with additional overlap in scenario U6). Panel A and B display the univariate GMM distributions of respectively scenarios U4 and U6, and Panel C and D the benchmarked distributions of respectively scenarios U4 and U6, built as Panel C of Figure \\ref{fig:four-component-balanced-separated}."

html_global_heatmap_univariate <- "Correlation heatmaps of the estimated parameters extended to the four initialisation methods benchmarked, using the same configuration described in Figure \\@ref(fig:dichotomy-package-conclusion), in the bivariate setting."
pdf_global_heatmap_univariate <- "Correlation heatmaps of the estimated parameters extended to the four initialisation methods benchmarked, using the same configuration described in Figure \\ref{fig:dichotomy-package-conclusion}, in the bivariate setting."

html_univariate_init_time <- "Distribution of the running times taken by each initialisation algorithm enumerated in Table \\@ref(tab:general-parameter-description-html), across all scenarios listed in Table \\@ref(tab:parameter-configuration-univariate), sorted by increasing ID number in the lexicographical order."
pdf_univariate_init_time <- "Distribution of the running times taken by each initialisation algorithm enumerated in Table \\ref{tab:general-parameter-description-pdf}, across all scenarios listed in Table \\ref{tab:parameter-configuration-univariate}, sorted by increasing ID number in the lexicographical order."


## ----compute-balanced-well-separated-table-univariate-table-------------------
univariate_parameters_local_scores_balanced_separated <- univariate_parameters_local_scores_summary %>%
  filter(ID=="U1") %>% select(-ID)
nrow_summary <- nrow(univariate_parameters_local_scores_balanced_separated)


## ----balanced-well-separated-table-univariate-pdf, eval=knitr::is_latex_output()----
univariate_parameters_local_scores_balanced_separated_kable <- univariate_parameters_local_scores_balanced_separated %>%
  kbl(booktabs=T, caption = "MSE and Bias associated to scenario U1, in Table \\ref{tab:parameter-configuration-univariate} (balanced and well-separated components)", escape=F,
      col.names = linebreak(c("Package", "Initialisation\nMethod",
                              "Global \n MSE $p$", "Global\nMSE $\\mu$", "Global\nMSE $\\sigma$",
                              "Global \n Bias $p$", "Global\nBias $\\mu$", "Global\nBias $\\sigma$"))) %>%
  kable_styling(latex_options=c("hold_position", "scale_down"), full_width = T) %>%
  row_spec(0,bold=T, align = "c") %>%
  column_spec(column = 1:8, latex_valign = "m") %>%
  column_spec(1, bold = T) %>% collapse_rows(columns = 1, valign = "middle")

for (metric_col in metric_colnames) {
  # define col vector
  col_vector <- rep("black", nrow_summary); metric_vector <- univariate_parameters_local_scores_balanced_separated %>% pull(metric_col)
  col_vector[which(metric_vector==min(metric_vector))] <- "green" # set minimal values to green
  col_vector[which(metric_vector==max(metric_vector))] <- "red" # set maximal values to red
  # set colours
  univariate_parameters_local_scores_balanced_separated_kable <- univariate_parameters_local_scores_balanced_separated_kable %>%
    column_spec(match(metric_col, names(univariate_parameters_local_scores_balanced_separated)),color=col_vector)
}
univariate_parameters_local_scores_balanced_separated_kable


## ----balanced-well-separated-table-univariate-html, eval=knitr::is_html_output(), layout = "l-body-outset"----
#> # latex + collapse rows + determine min and max
#> 
#> univariate_parameters_local_scores_balanced_separated_flex <- univariate_parameters_local_scores_balanced_separated %>% flextable() %>%
#>   set_caption(caption = "MSE and Bias associated to scenario U1, in Table [Table parameter in the univariate setting](#tab:parameter-configuration-univariate) (balanced and well-separated components)", html_escape = F)
#> 
#> for (metric_col in metric_colnames) {
#>   univariate_parameters_local_scores_balanced_separated_flex <- univariate_parameters_local_scores_balanced_separated_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==min(`", metric_col, "`)")),color = "green")
#> 
#>   univariate_parameters_local_scores_balanced_separated_flex <- univariate_parameters_local_scores_balanced_separated_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==max(`", metric_col, "`)")),color = "red")
#> }
#> 
#> univariate_parameters_local_scores_balanced_separated_flex %>%
#>   flextable::compose(j="global_mse_p", part = "header", value = as_paragraph("Global MSE \U0070")) %>%
#>   flextable::compose(j="global_mse_mu", part = "header", value = as_paragraph("Global MSE \U03BC")) %>%
#>   # flextable::compose(j="global_mse_ sigma", part = "header", value = as_paragraph("Global_mse_ ", as_equation("\\sigma"))) %>%
#>   flextable::compose(j="global_mse_sigma", part = "header", value = as_paragraph("Global MSE \U03C3")) %>%
#>   flextable::compose(j="global_bias_p", part = "header", value = as_paragraph("Global Bias \U0070")) %>%
#>   flextable::compose(j="global_bias_mu", part = "header", value = as_paragraph("Global Bias \U03BC")) %>%
#>   flextable::compose(j="global_bias_sigma", part = "header", value = as_paragraph("Global Bias \U03C3")) %>%
#>   set_header_labels(package= "Package", `initialisation method`="Initialisation Method") %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%  # centre align header
#>   merge_v(j = "Package") %>%   flextable::autofit()


## ----four-component-balanced-separated, fig.cap=if (univariate_html_ouput) html_caption_balanced_well_separated_univariate else pdf_caption_balanced_well_separated_univariate----

true_theta <- univariate_configuration %>% filter(ID=="U1") %>% pull(true_parameters) %>% magrittr::extract2(1)
upper_part <- cowplot::plot_grid(plot_univariate_normal_density_distribution(true_theta) + labs(tag="A"),
                                 plot_time_computations(univariate_time_computation %>% filter(initialisation_method=="kmeans" & ID == "U1")) +
                                   theme(plot.tag = element_text(size=18, face = "bold")) + labs(tag = "B"), ncol = 2, align = 'h', axis="tblr")

univariate_balanced_separated <- gridExtra::arrangeGrob(upper_part,
                                                             plot_boxplots_parameters(formatted_univariate_distribution_parameters %>%
                                                                                        filter(ID == "U1"), true_theta) +
                                                               theme(plot.tag = element_text(size=18, face = "bold"),
                                                                     axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4)) +
                                                               labs(tag = "C"), top="", nrow = 2, heights = c(1.2, 2), padding = unit(1, "line"))

ggsave("./figs/univariate/univariate_balanced_separated.png", univariate_balanced_separated,
       width = 24, height = 18,dpi = 75)
knitr::include_graphics("./figs/univariate/univariate_balanced_separated.png", dpi=75)


## ----compute-unbalanced-well-separated-table-univariate-table-----------------
univariate_parameters_local_scores_unbalanced_separated <- univariate_parameters_local_scores_summary %>%
  filter(ID=="U7") %>% select(-ID)
nrow_summary <- nrow(univariate_parameters_local_scores_unbalanced_separated)


## ----unbalanced-well-separated-table-univariate-pdf, eval=knitr::is_latex_output()----
univariate_parameters_local_scores_unbalanced_separated_kable <- univariate_parameters_local_scores_unbalanced_separated %>%
  kbl(booktabs=T, caption = "MSE and Bias associated to scenario U7, in Table \\ref{tab:parameter-configuration-univariate} (unbalanced and well-separated components)", escape=F,
      col.names = linebreak(c("Package", "Initialisation\nMethod",
                              "Global \n MSE $p$", "Global\nMSE $\\mu$", "Global\nMSE $\\sigma$",
                              "Global \n Bias $p$", "Global\nBias $\\mu$", "Global\nBias $\\sigma$"))) %>%
  kable_styling(latex_options=c("hold_position", "scale_down"), full_width = T) %>%
  row_spec(0,bold=T, align = "c") %>%
  column_spec(column = 1:8, latex_valign = "m") %>%
  column_spec(1, bold = T) %>% collapse_rows(columns = 1, valign = "middle")

for (metric_col in metric_colnames) {
  # define col vector
  col_vector <- rep("black", nrow_summary); metric_vector <- univariate_parameters_local_scores_unbalanced_separated %>% pull(metric_col)
  col_vector[which(metric_vector==min(metric_vector))] <- "green" # set minimal values to green
  col_vector[which(metric_vector==max(metric_vector))] <- "red" # set maximal values to red
  # set colours
  univariate_parameters_local_scores_unbalanced_separated_kable <- univariate_parameters_local_scores_unbalanced_separated_kable %>%
    column_spec(match(metric_col, names(univariate_parameters_local_scores_unbalanced_separated)),color=col_vector)
}
univariate_parameters_local_scores_unbalanced_separated_kable


## ----unbalanced-well-separated-table-univariate-html, eval=knitr::is_html_output(), layout = "l-body-outset"----
#> univariate_parameters_local_scores_unbalanced_separated_flex <- univariate_parameters_local_scores_unbalanced_separated %>% flextable() %>%
#>   set_caption(caption = "MSE and Bias associated to scenario U7, in Table [Table parameter in the univariate setting](#tab:parameter-configuration-univariate) (unbalanced and well-separated components)", html_escape = F)
#> 
#> for (metric_col in metric_colnames) {
#>   univariate_parameters_local_scores_unbalanced_separated_flex <- univariate_parameters_local_scores_unbalanced_separated_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==min(`", metric_col, "`)")),color = "green")
#> 
#>   univariate_parameters_local_scores_unbalanced_separated_flex <- univariate_parameters_local_scores_unbalanced_separated_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==max(`", metric_col, "`)")),color = "red")
#> }
#> 
#> univariate_parameters_local_scores_unbalanced_separated_flex %>%
#>   flextable::compose(j="global_mse_p", part = "header", value = as_paragraph("Global MSE \U0070")) %>%
#>   flextable::compose(j="global_mse_mu", part = "header", value = as_paragraph("Global MSE \U03BC")) %>%
#>   # flextable::compose(j="global_mse_ sigma", part = "header", value = as_paragraph("Global_mse_ ", as_equation("\\sigma"))) %>%
#>   flextable::compose(j="global_mse_sigma", part = "header", value = as_paragraph("Global MSE \U03C3")) %>%
#>   flextable::compose(j="global_bias_p", part = "header", value = as_paragraph("Global Bias \U0070")) %>%
#>   flextable::compose(j="global_bias_mu", part = "header", value = as_paragraph("Global Bias \U03BC")) %>%
#>   flextable::compose(j="global_bias_sigma", part = "header", value = as_paragraph("Global Bias \U03C3")) %>%
#>   set_header_labels(package= "Package", `initialisation method`="Initialisation Method") %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%  # centre align header
#>   merge_v(j = "Package") %>%   flextable::autofit()


## ----four-component-unbalanced-separated, fig.cap=if (univariate_html_ouput) html_caption_unbalanced_well_separated_univariate else pdf_caption_unbalanced_well_separated_univariate----

true_theta <- univariate_configuration %>% filter(ID=="U7") %>% pull(true_parameters) %>% magrittr::extract2(1)
upper_part <- cowplot::plot_grid(plot_univariate_normal_density_distribution(true_theta) + labs(tag="A"),
                                 plot_time_computations(univariate_time_computation %>% filter(initialisation_method=="kmeans" & ID == "U7")) +
                                   theme(plot.tag = element_text(size=18, face = "bold")) + labs(tag = "B"), ncol = 2, align = 'h', axis="tblr")

univariate_unbalanced_separated <- gridExtra::arrangeGrob(upper_part,
                                                             plot_boxplots_parameters(formatted_univariate_distribution_parameters %>%
                                                                                        filter(ID == "U7"), true_theta) +
                                                               theme(plot.tag = element_text(size=18, face = "bold"),
                                                                     axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4)) +
                                                               labs(tag = "C"), top="", nrow = 2, heights = c(1.2, 2), padding = unit(1, "line"))

ggsave("./figs/univariate/univariate_unbalanced_separated.png", univariate_unbalanced_separated,
       width = 24, height = 18,dpi = 75)
knitr::include_graphics("./figs/univariate/univariate_unbalanced_separated.png", dpi=75)


## ----compute-balanced-overlapping-table-univariate-table----------------------
univariate_parameters_local_scores_balanced_overlapping <- univariate_parameters_local_scores_summary %>%
  filter(ID=="U3") %>% select(-ID)
nrow_summary <- nrow(univariate_parameters_local_scores_balanced_overlapping)


## ----balanced-overlapping-table-univariate-pdf, eval=knitr::is_latex_output()----
univariate_parameters_local_scores_balanced_overlapping_kable <- univariate_parameters_local_scores_balanced_overlapping %>%
  kbl(booktabs=T, caption = "MSE and Bias associated to scenario U3, in Table \\ref{tab:parameter-configuration-univariate} (balanced and overlapping components)", escape=F,
      col.names = linebreak(c("Package", "Initialisation\nMethod",
                              "Global \n MSE $p$", "Global\nMSE $\\mu$", "Global\nMSE $\\sigma$",
                              "Global \n Bias $p$", "Global\nBias $\\mu$", "Global\nBias $\\sigma$"))) %>%
  kable_styling(latex_options=c("hold_position", "scale_down"), full_width = T) %>%
  row_spec(0,bold=T, align = "c") %>%
  column_spec(column = 1:8, latex_valign = "m") %>%
  column_spec(1, bold = T) %>% collapse_rows(columns = 1, valign = "middle")

for (metric_col in metric_colnames) {
  # define col vector
  col_vector <- rep("black", nrow_summary); metric_vector <- univariate_parameters_local_scores_balanced_overlapping %>% pull(metric_col)
  col_vector[which(metric_vector==min(metric_vector))] <- "green" # set minimal values to green
  col_vector[which(metric_vector==max(metric_vector))] <- "red" # set maximal values to red
  # set colours
  univariate_parameters_local_scores_balanced_overlapping_kable <- univariate_parameters_local_scores_balanced_overlapping_kable %>%
    column_spec(match(metric_col, names(univariate_parameters_local_scores_balanced_overlapping)),color=col_vector)
}
univariate_parameters_local_scores_balanced_overlapping_kable


## ----balanced-overlapping-table-univariate-html, eval=knitr::is_html_output(), layout = "l-body-outset"----
#> # latex + collapse rows + determine min and max
#> 
#> univariate_parameters_local_scores_balanced_overlapping_flex <- univariate_parameters_local_scores_balanced_overlapping %>% flextable() %>%
#>   set_caption(caption = "MSE and Bias associated to scenario U3, in Table [Table parameter in the univariate setting](#tab:parameter-configuration-univariate) (balanced and overlapping components)", html_escape = F)
#> 
#> for (metric_col in metric_colnames) {
#>   univariate_parameters_local_scores_balanced_overlapping_flex <- univariate_parameters_local_scores_balanced_overlapping_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==min(`", metric_col, "`)")),color = "green")
#> 
#>   univariate_parameters_local_scores_balanced_overlapping_flex <- univariate_parameters_local_scores_balanced_overlapping_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==max(`", metric_col, "`)")),color = "red")
#> }
#> 
#> univariate_parameters_local_scores_balanced_overlapping_flex %>%
#>   flextable::compose(j="global_mse_p", part = "header", value = as_paragraph("Global MSE \U0070")) %>%
#>   flextable::compose(j="global_mse_mu", part = "header", value = as_paragraph("Global MSE \U03BC")) %>%
#>   # flextable::compose(j="global_mse_ sigma", part = "header", value = as_paragraph("Global_mse_ ", as_equation("\\sigma"))) %>%
#>   flextable::compose(j="global_mse_sigma", part = "header", value = as_paragraph("Global MSE \U03C3")) %>%
#>   flextable::compose(j="global_bias_p", part = "header", value = as_paragraph("Global Bias \U0070")) %>%
#>   flextable::compose(j="global_bias_mu", part = "header", value = as_paragraph("Global Bias \U03BC")) %>%
#>   flextable::compose(j="global_bias_sigma", part = "header", value = as_paragraph("Global Bias \U03C3")) %>%
#>   set_header_labels(package= "Package", `initialisation method`="Initialisation Method") %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%  # centre align header
#>   merge_v(j = "Package") %>%   flextable::autofit()


## ----four-component-balanced-overlapping, fig.cap=if (univariate_html_ouput) html_caption_balanced_overlapping_univariate else pdf_caption_balanced_overlapping_univariate----

true_theta <- univariate_configuration %>% filter(ID=="U3") %>% pull(true_parameters) %>% magrittr::extract2(1)
upper_part <- cowplot::plot_grid(plot_univariate_normal_density_distribution(true_theta) + labs(tag="A"),
                                 plot_time_computations(univariate_time_computation %>% filter(initialisation_method=="kmeans" & ID == "U3")) +
                                   theme(plot.tag = element_text(size=18, face = "bold")) + labs(tag = "B"), ncol = 2, align = 'h', axis="tblr")

univariate_balanced_overlapping <- gridExtra::arrangeGrob(upper_part,
                                                             plot_boxplots_parameters(formatted_univariate_distribution_parameters %>%
                                                                                        filter(ID == "U3"), true_theta) +
                                                               theme(plot.tag = element_text(size=18, face = "bold"),
                                                                     axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4)) +
                                                               labs(tag = "C"), top="", nrow = 2, heights = c(1.2, 2), padding = unit(1, "line"))

ggsave("./figs/univariate/univariate_balanced_overlapping.png", univariate_balanced_overlapping,
       width = 24, height = 18,dpi = 75)
knitr::include_graphics("./figs/univariate/univariate_balanced_overlapping.png", dpi=75)


## ----compute-unbalanced-overlapping-table-univariate-table--------------------
univariate_parameters_local_scores_unbalanced_overlapping <- univariate_parameters_local_scores_summary %>%
  filter(ID=="U9") %>% select(-ID)
nrow_summary <- nrow(univariate_parameters_local_scores_unbalanced_overlapping)


## ----unbalanced-overlapping-table-univariate-pdf, eval=knitr::is_latex_output()----
univariate_parameters_local_scores_unbalanced_overlapping_kable <- univariate_parameters_local_scores_unbalanced_overlapping %>%
  kbl(booktabs=T, caption = "MSE and Bias associated to scenario U9, in Table \\ref{tab:parameter-configuration-univariate} (unbalanced and overlapping components)", escape=F,
      col.names = linebreak(c("Package", "Initialisation\nMethod",
                              "Global \n MSE $p$", "Global\nMSE $\\mu$", "Global\nMSE $\\sigma$",
                              "Global \n Bias $p$", "Global\nBias $\\mu$", "Global\nBias $\\sigma$"))) %>%
  kable_styling(latex_options=c("hold_position", "scale_down"), full_width = T) %>%
  row_spec(0,bold=T, align = "c") %>%
  column_spec(column = 1:8, latex_valign = "m") %>%
  column_spec(1, bold = T) %>% collapse_rows(columns = 1, valign = "middle")

for (metric_col in metric_colnames) {
  # define col vector
  col_vector <- rep("black", nrow_summary); metric_vector <- univariate_parameters_local_scores_unbalanced_overlapping %>% pull(metric_col)
  col_vector[which(metric_vector==min(metric_vector))] <- "green" # set minimal values to green
  col_vector[which(metric_vector==max(metric_vector))] <- "red" # set maximal values to red
  # set colours
  univariate_parameters_local_scores_unbalanced_overlapping_kable <- univariate_parameters_local_scores_unbalanced_overlapping_kable %>%
    column_spec(match(metric_col, names(univariate_parameters_local_scores_unbalanced_overlapping)),color=col_vector)
}
univariate_parameters_local_scores_unbalanced_overlapping_kable


## ----unbalanced-overlapping-table-univariate-html, eval=knitr::is_html_output(), layout = "l-body-outset"----
#> # latex + collapse rows + determine min and max
#> 
#> univariate_parameters_local_scores_unbalanced_overlapping_flex <- univariate_parameters_local_scores_unbalanced_overlapping %>% flextable() %>%
#>   set_caption(caption = "MSE and Bias associated to scenario U9, in Table [Table parameter in the univariate setting](#tab:parameter-configuration-univariate) (unbalanced and overlapping components)", html_escape = F)
#> 
#> for (metric_col in metric_colnames) {
#>   univariate_parameters_local_scores_unbalanced_overlapping_flex <- univariate_parameters_local_scores_unbalanced_overlapping_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==min(`", metric_col, "`)")),color = "green")
#> 
#>   univariate_parameters_local_scores_unbalanced_overlapping_flex <- univariate_parameters_local_scores_unbalanced_overlapping_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==max(`", metric_col, "`)")),color = "red")
#> }
#> 
#> univariate_parameters_local_scores_unbalanced_overlapping_flex %>%
#>   flextable::compose(j="global_mse_p", part = "header", value = as_paragraph("Global MSE \U0070")) %>%
#>   flextable::compose(j="global_mse_mu", part = "header", value = as_paragraph("Global MSE \U03BC")) %>%
#>   # flextable::compose(j="global_mse_ sigma", part = "header", value = as_paragraph("Global_mse_ ", as_equation("\\sigma"))) %>%
#>   flextable::compose(j="global_mse_sigma", part = "header", value = as_paragraph("Global MSE \U03C3")) %>%
#>   flextable::compose(j="global_bias_p", part = "header", value = as_paragraph("Global Bias \U0070")) %>%
#>   flextable::compose(j="global_bias_mu", part = "header", value = as_paragraph("Global Bias \U03BC")) %>%
#>   flextable::compose(j="global_bias_sigma", part = "header", value = as_paragraph("Global Bias \U03C3")) %>%
#>   set_header_labels(package= "Package", `initialisation method`="Initialisation Method") %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%  # centre align header
#>   merge_v(j = "Package") %>%   flextable::autofit()


## ----four-component-unbalanced-overlapping, fig.cap=if (univariate_html_ouput) html_caption_unbalanced_overlapping_univariate else pdf_caption_unbalanced_overlapping_univariate----

true_theta <- univariate_configuration %>% filter(ID=="U9") %>% pull(true_parameters) %>% magrittr::extract2(1)
upper_part <- cowplot::plot_grid(plot_univariate_normal_density_distribution(true_theta) + labs(tag="A"),
                                 plot_time_computations(univariate_time_computation %>% filter(initialisation_method=="kmeans" & ID == "U9")) +
                                   theme(plot.tag = element_text(size=18, face = "bold")) + labs(tag = "B"), ncol = 2, align = 'h', axis="tblr")

univariate_unbalanced_overlapping <- gridExtra::arrangeGrob(upper_part,
                                                             plot_boxplots_parameters(formatted_univariate_distribution_parameters %>%
                                                                                        filter(ID == "U9"), true_theta) +
                                                               theme(plot.tag = element_text(size=18, face = "bold"),
                                                                     axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4)) +
                                                               labs(tag = "C"), top="", nrow = 2, heights = c(1.2, 2), padding = unit(1, "line"))

ggsave("./figs/univariate/univariate_unbalanced_overlapping.png", univariate_unbalanced_overlapping,
       width = 24, height = 18,dpi = 75)
knitr::include_graphics("./figs/univariate/univariate_unbalanced_overlapping.png", dpi=75)


## ----four-components-midbalanced, fig.cap=if (univariate_html_ouput) html_caption_intermediate_scenario_univariate else pdf_caption_intermediate_scenario_univariate----
true_theta_scenario_U4 <- univariate_configuration %>% filter(ID=="U4") %>% pull(true_parameters) %>% magrittr::extract2(1)
true_theta_scenario_U6 <- univariate_configuration %>% filter(ID=="U6") %>% pull(true_parameters) %>% magrittr::extract2(1)

four_components_midbalanced_separated <- gridExtra::arrangeGrob(plot_univariate_normal_density_distribution(true_theta_scenario_U4) + labs(tag="A") +
                                                                  theme(plot.tag = element_text(size=18, face = "bold")),
                                                                plot_univariate_normal_density_distribution(true_theta_scenario_U6) + labs(tag="B") +
                                                                  theme(plot.tag = element_text(size=18, face = "bold")),
                                                                plot_boxplots_parameters(formatted_univariate_distribution_parameters %>% filter(ID=="U4"), true_theta_scenario_U6) +
                                                                  theme(plot.tag = element_text(size=18, face = "bold"),
                                                                        axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4)) + labs(tag = "C"),
                                                                plot_boxplots_parameters(formatted_univariate_distribution_parameters %>% filter(ID=="U6"), true_theta_scenario_U6) +
                                                                  theme(plot.tag = element_text(size=18, face = "bold"),
                                                                        axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4)) + labs(tag = "D"),
                                                                top="", layout_matrix = matrix(c(1, 2, 3, 3, 4, 4), byrow = TRUE, nrow = 3), heights = c(2, 2.5, 2.5), padding = unit(1, "line"))

ggsave("figs/univariate/univariate_midbalanced.png", four_components_midbalanced_separated,
       width = 22, height = 26,dpi = 75)
knitr::include_graphics("figs/univariate/univariate_midbalanced.png", dpi=75)


## ----heatmap-all-correlation-plots-univariate, fig.cap= if (univariate_html_ouput) html_global_heatmap_univariate else pdf_global_heatmap_univariate----
discriminating_data <- univariate_distribution_parameters %>% dplyr::filter(ID=="U9") %>% 
  dplyr::bind_rows(readRDS("./tables/univariate/univariate_small_EM.rds"))

univariate_correlation_heatmaps <- plot_correlation_Heatmap(discriminating_data)

univariate_correlation_heatmaps <- gridExtra::arrangeGrob(grobs=univariate_correlation_heatmaps %>% purrr::map(~grid::grid.grabExpr(ComplexHeatmap::draw(.x))),
                                                          top="", ncol = 2)
ggsave("./figs/univariate/heatmap_univariate.png", univariate_correlation_heatmaps, width = 10.5, height = 13.5,dpi = 75)

knitr::include_graphics("./figs/univariate/heatmap_univariate.png", dpi = 75)


## ----univariate-initialisation-time-computations, fig.cap= if (univariate_html_ouput) html_univariate_init_time else pdf_univariate_init_time----

initialisation_time_data <- readRDS("./tables/univariate/univariate_initialisation_time_computation.rds")
inialisation_plot <- plot_initialisation_time_computations(initialisation_time_data, size=4, x = 2.6)
ggsave("./figs/univariate_initialisation_time_computations.png", inialisation_plot, dpi = 75)

knitr::include_graphics("./figs/univariate_initialisation_time_computations.png", dpi = 75)


## ----parameter-configuration-bivariate----------------------------------------
multivariate_configuration  %>% mutate(Proportions=purrr::map_chr(true_parameters, ~paste(.x$p, collapse = " / ")),
                                       Means=purrr::map_chr(true_parameters, ~paste0("(", paste0(.x$mu[,1], collapse = ","), ");(", paste0(.x$mu[,2], collapse = ","), ")")),
                                       Correlations=purrr::map_chr(true_parameters, ~paste(c(.x$sigma[1, 2, 1], .x$sigma[1, 2, 2]), collapse = " / "))) %>%
  select(-c("OVL", "nobservations", "prop_outliers", "true_parameters", "formatted_true_parameters", "true_parameters_factor")) %>%
  rename(Entropy=entropy, OVL=OVL_pairwise) %>%
  kbl(booktabs=T, caption = "The 20 parameter configurations tested to generate the samples of the bivariate experiment.",
      escape=F, align = "c") %>%
  kable_styling(latex_options=c("hold_position", "scale_down")) %>%
  row_spec(0,bold=T) %>% row_spec(1:20, hline_after = T) %>%
  kable_styling(bootstrap_options = c("hover", "condensed"))


## ----prepare-legend-multivariate----------------------------------------------
multivariate_html_ouput <- knitr::is_html_output()  # change to TRUE for larger figures

html_caption_unbalanced_negative_correlated_multivariate <- "Benchmark plots of scenario B11 in Table \\@ref(tab:parameter-configuration-bivariate) (unbalanced, overlapping and negative correlated components), organised as such:

 - The panel A displays the bivariate contour maps associated to the two-components multivariate Gaussian distribution corresponding to the parametrisation described by the scenario, warmer colours corresponding to regions of higher densities. The two centroids, whose coordinates are given by the mean components' elements, are represented with distinct shaped and coloured point estimates.

  - In both Panels A and B, the ellipsoids correspond to the $95\\%$ confidence region associated to each component's distribution. To generate them, we largely inspired from the `r downlit::autolink('mixtools::ellipse()')` and website [How to draw ellipses](https://cookierobotics.com/007/). To generate them, we retain for each individual parameter its mean (similar results with the median) over the $N=100$ sampling experiments, restrained to the random initialisation method.

- The running times are displayed in Panel C with the *k*-means initialisation. The number of observations
(x-axis) and the running time (y-axis) is in $\\log(10)$ scale. The points represent median
running time. The coloured bands represent the $5^{\\text{th}}$ and $95^{\\text{th}}$ percentiles
of the running time.

- The distributions of the Hellinger distances (a closed form is only available for the Gaussian multivariate distribution, not the mixture) are computed for each component, each initialisation method and each package with respect to the true Gaussian distribution expected for each component. The more dissimilar are the distributions, the higher is the Hellinger distance, knowing it is normalised between 0 and 1^[More on the Hellinger distance as a quantifier of the similarity between two probability distributions in [Hellinger distance](https://en.wikipedia.org/wiki/Hellinger_distance)]. We represent them using boxplot representations in Panel D.

- In panel E we represent the boxplots associated with the distribution of the estimates, with one box per pair of package and initialisation method, using the same convenstions detailed in [Supplementary Figures and Tables in the univariate simulation]. As the correlation is a symmetric operator, we only represent the distribution of the lower part of the lower matrix. Each column is associated to the parameters of a component. First row represents the distribution of the estimated ratios, second and third respectively the distributions of the mean vector on the x-axis and on the y-axis, third and four the distributions of the individual variances of each feature and finally the fifth row shows the distribution of the correlation between dimension 1 and 2."


pdf_caption_unbalanced_negative_correlated_multivariate <- "Benchmark plots of scenario B11 in Table \\ref{tab:parameter-configuration-bivariate} (unbalanced, overlapping and negative correlated components),  organised as such: 
The panel A displays the bivariate contour maps associated to the two-components multivariate Gaussian distribution corresponding to the parametrisation described by the scenario, warmer colours corresponding to regions of higher densities. The two centroids, whose coordinates are given by the mean components' elements, are represented with distinct shaped and coloured point estimates.
In both Panels A and B, the ellipsoids correspond to the $95\\%$ confidence region associated to each component's distribution. To generate them, we largely inspired from the \\code{mixtools::ellipse()} and website \\href{https://cookierobotics.com/007/}{How to draw ellipses}. To generate them, we retain for each individual parameter its mean (similar results with the median) over the $N=100$ sampling experiments, restrained to the random initialisation method.
The running times are displayed in Panel C with the \\textit{k}-means initialisation. The number of observations
(x-axis) and the running time (y-axis) is in $\\log(10)$ scale. The points represent median
running time. The coloured bands represent the $5^{\\text{th}}$ and $95^{\\text{th}}$ percentiles
of the running time.
The distributions of the Hellinger distances (a closed form is only available for the Gaussian multivariate distribution, not the mixture) are computed for each component, each initialisation method and each package with respect to the true Gaussian distribution expected for each component. The more dissimilar are the distributions, the higher is the Hellinger distance, knowing it is normalised between 0 and 1. We represent them using boxplot representations in Panel D.
In panel E we represent the boxplots associated with the distribution of the estimates, with one box per pair of package and initialisation method, using the same conventions detailed in \\nameref{Supplementary Figures and Tables in the univariate simulation}. As the correlation is a symmetric operator, we only represent the distribution of the lower part of the lower matrix. Each column is associated to the parameters of a component. First row represents the distribution of the estimated ratios, second and third respectively the distributions of the mean vector on the x-axis and on the y-axis, third and four the distributions of the individual variances of each feature and finally the fifth row shows the distribution of the correlation between dimension 1 and 2."



html_caption_unbalanced_opposite_correlated_multivariate <- "Benchmark plots of scenario B12 in Table \\@ref(tab:parameter-configuration-bivariate)  (unbalanced, overlapping and opposite correlated components), with the same layout as Figure \\@ref(fig:multivariate-overlapping-unbalanced-negative-correlated)."
pdf_caption_unbalanced_opposite_correlated_multivariate <- "Benchmark plots of scenario B12 in Table \\ref{tab:parameter-configuration-bivariate} (unbalanced, overlapping and opposite correlated components), with the same layout as Figure \\ref{fig:multivariate-overlapping-unbalanced-negative-correlated}."

html_caption_unbalanced_positive_correlated_multivariate <- "Benchmark plots of scenario B14 in Table \\@ref(tab:parameter-configuration-bivariate) (unbalanced, overlapping and positive correlated components), with the same layout as Figure \\@ref(fig:multivariate-overlapping-unbalanced-negative-correlated)."
pdf_caption_unbalanced_positive_correlated_multivariate <- "Benchmark plots of scenario B14 in Table \\ref{tab:parameter-configuration-bivariate} (unbalanced, overlapping and positive correlated components), with the same layout as Figure \\ref{fig:multivariate-overlapping-unbalanced-negative-correlated}."

html_caption_unbalanced_uncorrelated_multivariate <- "Benchmark plots of scenario B15 in Table \\@ref(tab:parameter-configuration-bivariate) (unbalanced, overlapping and uncorrelated components), with the same layout as Figure \\@ref(fig:multivariate-overlapping-unbalanced-negative-correlated)."
pdf_caption_unbalanced_uncorrelated_multivariate <- "Benchmark plots of scenario B15 in Table \\ref{tab:parameter-configuration-bivariate} (unbalanced, overlapping and uncorrelated components), with the same layout as Figure \\ref{fig:multivariate-overlapping-unbalanced-negative-correlated}."



html_balanced_overlapping_general_multivariate <- "Benchmark summary plots of scenarios B1, B2 and B5 in Table \\@ref(tab:parameter-configuration-bivariate) featuring balanced and overlapping clusters. Summary plots of B1, B2 and B5 are represented in this order on each row, with the left column displaying the 95% confidence ellipsoidal regions associated to the mean estimated parameters across each package and the right column the distribution of the Hellinger distances."
pdf_balanced_overlapping_general_multivariate <- "Benchmark summary plots of respectively scenarios B1, B2 and B5 in Table \\ref{tab:parameter-configuration-bivariate} featuring balanced and overlapping clusters. Summary plots of B1, B2 and B5 are represented in this order on each row, with the left column displaying the $95\\%$ confidence ellipsoidal regions associated to the mean estimated parameters across each package and the right column the distribution of the Hellinger distances."

html_balanced_well_separated_general_multivariate <- "Benchmark summary plots of respectively scenarios B6, B7 and B10 in Table \\@ref(tab:parameter-configuration-bivariate) featuring balanced and well-separated clusters, with the same layout as Figure @\\ref(fig:general-balanced-overlapping-multivariate)."
pdf_balanced_well_separated_general_multivariate <- "Benchmark summary plots of respectively scenarios B6, B7 and B10 in Table \\ref{tab:parameter-configuration-bivariate} featuring balanced and well-separated clusters, with the same layout as Figure \\ref{fig:general-balanced-overlapping-multivariate}."

html_unbalanced_well_separated_general_multivariate <- "Benchmark summary plots of respectively scenarios B16, B17 and B20 in Table \\@ref(tab:parameter-configuration-bivariate) featuring unbalanced and well-separated clusters, with the same layout as Figure @\\ref(fig:general-balanced-overlapping-multivariate).."
pdf_unbalanced_well_separated_general_multivariate <- "Benchmark summary plots of respectively scenarios B16, B17 and B20 in Table \\ref{tab:parameter-configuration-bivariate} featuring unbalanced and well-separated clusters, with the same layout as Figure \\ref{fig:general-balanced-overlapping-multivariate}."

html_global_heatmap_multivariate <- "Correlation heatmaps of the estimated parameters in the bivariate setting extended to the four initialisation methods benchmarked, with the most discriminating scenario B11, using the same process described in Figure \\@ref(fig:dichotomy-package-conclusion)."
pdf_global_heatmap_multivariate <- "Correlation heatmaps of the estimated parameters in the bivariate setting extended to the four initialisation methods benchmarked, with the most discriminating scenario B11, using the same process described in Figure \\ref{fig:dichotomy-package-conclusion}."


## ----compute-multivariate-overlapping-unbalanced-negative-correlated----------
specific_multivariate_parameters_local_scores <- multivariate_parameters_local_scores_summary %>%
  dplyr::filter(ID=="B11") %>% select(-ID)
nrow_summary <- nrow(specific_multivariate_parameters_local_scores)


## ----multivariate-overlapping-unbalanced-negative-correlated-pdf, eval=knitr::is_latex_output()----
specific_multivariate_parameters_local_scores_kable <- specific_multivariate_parameters_local_scores %>%
  kbl(booktabs=T, caption = "MSE and Bias associated to scenario B11, in Table \\ref{tab:parameter-configuration-bivariate} (unbalanced, overlapping and negative correlated components).", escape=F,
      col.names = linebreak(c("Package", "Initialisation\nMethod",
                              "Global \n MSE $p$", "Global\nMSE $\\mu$", "Global\nMSE $\\sigma$",
                              "Global \n Bias $p$", "Global\nBias $\\mu$", "Global\nBias $\\sigma$"))) %>%
  kable_styling(latex_options=c("hold_position", "scale_down"), full_width = T) %>%
  row_spec(0,bold=T, align = "c") %>%
  column_spec(column = 1:8, latex_valign = "m") %>%
  column_spec(1, bold = T) %>% collapse_rows(columns = 1, valign = "middle")


for (metric_col in metric_colnames) {
  # define col vector
  col_vector <- rep("black", nrow_summary); metric_vector <- specific_multivariate_parameters_local_scores %>% pull(metric_col)
  col_vector[which(metric_vector==min(metric_vector))] <- "green" # set minimal values to green
  col_vector[which(metric_vector==max(metric_vector))] <- "red" # set maximal values to red
  # set colours
  specific_multivariate_parameters_local_scores_kable <- specific_multivariate_parameters_local_scores_kable %>%
    column_spec(match(metric_col, names(specific_multivariate_parameters_local_scores)),color=col_vector)
}
specific_multivariate_parameters_local_scores_kable


## ----multivariate-overlapping-unbalanced-negative-correlated-html, eval=knitr::is_html_output(), layout = "l-body-outset"----
#> specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores %>% flextable() %>%
#>   set_caption(caption = "MSE and Bias associated to scenario B11, in Table [Table parameter in the bivariate setting](#tab:parameter-configuration-bivariate) (unbalanced, overlapping and negative correlated components.)", html_escape = F)
#> 
#> for (metric_col in metric_colnames) {
#>   specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==min(`", metric_col, "`)")),color = "green")
#> 
#>   specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==max(`", metric_col, "`)")),color = "red")
#> }
#> 
#> specific_multivariate_parameters_local_scores_flex %>%
#>   flextable::compose(j="global_mse_p", part = "header", value = as_paragraph("Global MSE \U0070")) %>%
#>   flextable::compose(j="global_mse_mu", part = "header", value = as_paragraph("Global MSE \U03BC")) %>%
#>   # flextable::compose(j="global_mse_ sigma", part = "header", value = as_paragraph("Global_mse_ ", as_equation("\\sigma"))) %>%
#>   flextable::compose(j="global_mse_sigma", part = "header", value = as_paragraph("Global MSE \U03C3")) %>%
#>   flextable::compose(j="global_bias_p", part = "header", value = as_paragraph("Global Bias \U0070")) %>%
#>   flextable::compose(j="global_bias_mu", part = "header", value = as_paragraph("Global Bias \U03BC")) %>%
#>   flextable::compose(j="global_bias_sigma", part = "header", value = as_paragraph("Global Bias \U03C3")) %>%
#>   set_header_labels(package= "Package", `initialisation method`="Initialisation Method") %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%  # centre align header
#>   merge_v(j = "Package") %>%   flextable::autofit()
#> 


## ----multivariate-overlapping-unbalanced-negative-correlated, fig.cap=if (multivariate_html_ouput) html_caption_unbalanced_negative_correlated_multivariate else pdf_caption_unbalanced_negative_correlated_multivariate, out.width="60%"----
true_theta <- multivariate_configuration %>% filter(ID=="B11") %>% pull(true_parameters) %>% magrittr::extract2(1)

# generate plots
bivariate_density <- plot_bivariate_normal_density_distribution(true_theta=true_theta, n = 2000)
computation_time <- plot_time_computations(multivariate_time_computations %>% filter(ID == "B11"))
ellipse <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID == "B11"), true_theta)
hellinger <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID == "B11"), true_theta) +
  theme(axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4))
boxplot_parameter_bivariate <- plot_boxplots_parameters(formatted_multivariate_distribution_parameters %>% filter(ID == "B11"), true_theta) + theme(axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4))


# concatenate plots together
upper_part <- cowplot::plot_grid(bivariate_density + labs(tag="A") + theme(plot.tag = element_text(size=24, face = "bold")),
                                 ellipse + labs(tag="B") + theme(plot.tag = element_text(size=24, face = "bold"), legend.title = element_blank()),
                                 computation_time + labs(tag="C") + theme(plot.tag = element_text(size=24, face = "bold")),
                                 hellinger + labs(tag = "D") + theme(plot.tag = element_text(size=24, face = "bold")) ,
                                 ncol = 2, align = 'h', axis="tblr", nrow=2)
global_figure <- gridExtra::arrangeGrob(upper_part,
                                        boxplot_parameter_bivariate +
                                          theme(plot.tag = element_text(size=24, face = "bold")) + labs(tag = "E"),
                                        top="", nrow = 2, heights = c(1.5, 1), padding = unit(1, "line"))
ggsave("figs/multivariate/multivariate_unbalanced_overlapping_negatively_correlated.png",
       global_figure, width = 20, height = 24, dpi=75)

knitr::include_graphics("figs/multivariate/multivariate_unbalanced_overlapping_negatively_correlated.png", dpi=75)


## ----compute-multivariate-overlapping-unbalanced-opposite-correlated----------
specific_multivariate_parameters_local_scores <- multivariate_parameters_local_scores_summary %>%
  dplyr::filter(ID=="B12") %>% select(-ID)
nrow_summary <- nrow(specific_multivariate_parameters_local_scores)


## ----multivariate-overlapping-unbalanced-opposite-correlated-pdf, eval=knitr::is_latex_output()----
specific_multivariate_parameters_local_scores_kable <- specific_multivariate_parameters_local_scores %>%
  kbl(booktabs=T, caption = "MSE and Bias associated to scenario B12, in Table \\ref{tab:parameter-configuration-bivariate} (unbalanced, overlapping and opposite correlated components).", escape=F,
      col.names = linebreak(c("Package", "Initialisation\nMethod",
                              "Global \n MSE $p$", "Global\nMSE $\\mu$", "Global\nMSE $\\sigma$",
                              "Global \n Bias $p$", "Global\nBias $\\mu$", "Global\nBias $\\sigma$"))) %>%
  kable_styling(latex_options=c("hold_position", "scale_down"), full_width = T) %>%
  row_spec(0,bold=T, align = "c") %>%
  column_spec(column = 1:8, latex_valign = "m") %>%
  column_spec(1, bold = T) %>% collapse_rows(columns = 1, valign = "middle")


for (metric_col in metric_colnames) {
  # define col vector
  col_vector <- rep("black", nrow_summary); metric_vector <- specific_multivariate_parameters_local_scores %>% pull(metric_col)
  col_vector[which(metric_vector==min(metric_vector))] <- "green" # set minimal values to green
  col_vector[which(metric_vector==max(metric_vector))] <- "red" # set maximal values to red
  # set colours
  specific_multivariate_parameters_local_scores_kable <- specific_multivariate_parameters_local_scores_kable %>%
    column_spec(match(metric_col, names(specific_multivariate_parameters_local_scores)),color=col_vector)
}
specific_multivariate_parameters_local_scores_kable


## ----multivariate-overlapping-unbalanced-opposite-correlated-html, eval=knitr::is_html_output(), layout = "l-body-outset"----
#> specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores %>% flextable() %>%
#>   set_caption(caption = "MSE and Bias associated to scenario B12, in Table [Table parameter in the bivariate setting](#tab:parameter-configuration-bivariate)(unbalanced, overlapping and opposite correlated components.)", html_escape = F)
#> 
#> for (metric_col in metric_colnames) {
#>   specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==min(`", metric_col, "`)")),color = "green")
#> 
#>   specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==max(`", metric_col, "`)")),color = "red")
#> }
#> 
#> specific_multivariate_parameters_local_scores_flex %>%
#>   flextable::compose(j="global_mse_p", part = "header", value = as_paragraph("Global MSE \U0070")) %>%
#>   flextable::compose(j="global_mse_mu", part = "header", value = as_paragraph("Global MSE \U03BC")) %>%
#>   # flextable::compose(j="global_mse_ sigma", part = "header", value = as_paragraph("Global_mse_ ", as_equation("\\sigma"))) %>%
#>   flextable::compose(j="global_mse_sigma", part = "header", value = as_paragraph("Global MSE \U03C3")) %>%
#>   flextable::compose(j="global_bias_p", part = "header", value = as_paragraph("Global Bias \U0070")) %>%
#>   flextable::compose(j="global_bias_mu", part = "header", value = as_paragraph("Global Bias \U03BC")) %>%
#>   flextable::compose(j="global_bias_sigma", part = "header", value = as_paragraph("Global Bias \U03C3")) %>%
#>   set_header_labels(package= "Package", `initialisation method`="Initialisation Method") %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%  # centre align header
#>   merge_v(j = "Package") %>%   flextable::autofit()
#> 


## ----multivariate-overlapping-unbalanced-opposite-correlated, fig.cap=if (multivariate_html_ouput) html_caption_unbalanced_opposite_correlated_multivariate else pdf_caption_unbalanced_opposite_correlated_multivariate----
true_theta <- multivariate_configuration %>% filter(ID=="B12") %>% pull(true_parameters) %>% magrittr::extract2(1)

# generate plots
bivariate_density <- plot_bivariate_normal_density_distribution(true_theta=true_theta, n = 2000)
computation_time <- plot_time_computations(multivariate_time_computations %>% filter(ID == "B13"))
ellipse <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID == "B13"), true_theta)
hellinger <- plot_Hellinger(formatted_multivariate_distribution_parameters%>% filter(ID == "B13"), true_theta) +
  theme(axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4))
boxplot_parameter_bivariate <- plot_boxplots_parameters(formatted_multivariate_distribution_parameters %>% filter(ID == "B13"), true_theta) +
  theme(axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4))


# concatenate plots together
upper_part <- cowplot::plot_grid(bivariate_density + labs(tag="A") + theme(plot.tag = element_text(size=24, face = "bold")),
                                 ellipse + labs(tag="B") + theme(plot.tag = element_text(size=24, face = "bold"), legend.title = element_blank()),
                                 computation_time + labs(tag="C") + theme(plot.tag = element_text(size=24, face = "bold")),
                                 hellinger + labs(tag = "D") + theme(plot.tag = element_text(size=24, face = "bold")) ,
                                 ncol = 2, align = 'h', axis="tblr", nrow=2)
global_figure <- gridExtra::arrangeGrob(upper_part,
                                        boxplot_parameter_bivariate +
                                          theme(plot.tag = element_text(size=24, face = "bold")) + labs(tag = "E"),
                                        top="", nrow = 2, heights = c(1.5, 1), padding = unit(1, "line"))
ggsave("figs/multivariate/multivariate_unbalanced_overlapping_opposite_correlated.png",
       global_figure, width = 20, height = 24, dpi=75)

knitr::include_graphics("figs/multivariate/multivariate_unbalanced_overlapping_opposite_correlated.png", dpi=75)


## ----compute-multivariate-overlapping-unbalanced-positive-correlated----------
specific_multivariate_parameters_local_scores <- multivariate_parameters_local_scores_summary %>%
  dplyr::filter(ID=="B14") %>% select(-ID)
nrow_summary <- nrow(specific_multivariate_parameters_local_scores)


## ----multivariate-overlapping-unbalanced-positive-correlated-pdf, eval=knitr::is_latex_output()----
specific_multivariate_parameters_local_scores_kable <- specific_multivariate_parameters_local_scores %>%
  kbl(booktabs=T, caption = "MSE and Bias associated to scenario B14, in Table \\ref{tab:parameter-configuration-bivariate}  (unbalanced, overlapping and positive correlated components).", escape=F,
      col.names = linebreak(c("Package", "Initialisation\nMethod",
                              "Global \n MSE $p$", "Global\nMSE $\\mu$", "Global\nMSE $\\sigma$",
                              "Global \n Bias $p$", "Global\nBias $\\mu$", "Global\nBias $\\sigma$"))) %>%
  kable_styling(latex_options=c("hold_position", "scale_down"), full_width = T) %>%
  row_spec(0,bold=T, align = "c") %>%
  column_spec(column = 1:8, latex_valign = "m") %>%
  column_spec(1, bold = T) %>% collapse_rows(columns = 1, valign = "middle")


for (metric_col in metric_colnames) {
  # define col vector
  col_vector <- rep("black", nrow_summary); metric_vector <- specific_multivariate_parameters_local_scores %>% pull(metric_col)
  col_vector[which(metric_vector==min(metric_vector))] <- "green" # set minimal values to green
  col_vector[which(metric_vector==max(metric_vector))] <- "red" # set maximal values to red
  # set colours
  specific_multivariate_parameters_local_scores_kable <- specific_multivariate_parameters_local_scores_kable %>%
    column_spec(match(metric_col, names(specific_multivariate_parameters_local_scores)),color=col_vector)
}
specific_multivariate_parameters_local_scores_kable


## ----multivariate-overlapping-unbalanced-positive-correlated-html, eval=knitr::is_html_output(), layout = "l-body-outset"----
#> specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores %>% flextable() %>%
#>   set_caption(caption = "MSE and Bias associated to scenario B14, in Table [Table parameter in the bivariate setting](#tab:parameter-configuration-bivariate) (unbalanced, overlapping and positive correlated components.)", html_escape = F)
#> 
#> for (metric_col in metric_colnames) {
#>   specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==min(`", metric_col, "`)")),color = "green")
#> 
#>   specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==max(`", metric_col, "`)")),color = "red")
#> }
#> 
#> specific_multivariate_parameters_local_scores_flex %>%
#>   flextable::compose(j="global_mse_p", part = "header", value = as_paragraph("Global MSE \U0070")) %>%
#>   flextable::compose(j="global_mse_mu", part = "header", value = as_paragraph("Global MSE \U03BC")) %>%
#>   # flextable::compose(j="global_mse_ sigma", part = "header", value = as_paragraph("Global_mse_ ", as_equation("\\sigma"))) %>%
#>   flextable::compose(j="global_mse_sigma", part = "header", value = as_paragraph("Global MSE \U03C3")) %>%
#>   flextable::compose(j="global_bias_p", part = "header", value = as_paragraph("Global Bias \U0070")) %>%
#>   flextable::compose(j="global_bias_mu", part = "header", value = as_paragraph("Global Bias \U03BC")) %>%
#>   flextable::compose(j="global_bias_sigma", part = "header", value = as_paragraph("Global Bias \U03C3")) %>%
#>   set_header_labels(package= "Package", `initialisation method`="Initialisation Method") %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%  # centre align header
#>   merge_v(j = "Package") %>%   flextable::autofit()
#> 


## ----multivariate-overlapping-unbalanced-positive-correlated, fig.cap=if (multivariate_html_ouput) html_caption_unbalanced_positive_correlated_multivariate else pdf_caption_unbalanced_positive_correlated_multivariate----
true_theta <- multivariate_configuration %>% filter(ID=="B14") %>% pull(true_parameters) %>% magrittr::extract2(1)

# generate plots
bivariate_density <- plot_bivariate_normal_density_distribution(true_theta=true_theta, n = 2000)
computation_time <- plot_time_computations(multivariate_time_computations %>% filter(ID == "B14"))
ellipse <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID == "B14"), true_theta)
hellinger <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID == "B14"), true_theta) +
  theme(axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4))
boxplot_parameter_bivariate <- plot_boxplots_parameters(formatted_multivariate_distribution_parameters %>% filter(ID == "B14"), true_theta) +
  theme(axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4))


# concatenate plots together
upper_part <- cowplot::plot_grid(bivariate_density + labs(tag="A") + theme(plot.tag = element_text(size=24, face = "bold")),
                                 ellipse + labs(tag="B") + theme(plot.tag = element_text(size=24, face = "bold"), legend.title = element_blank()),
                                 computation_time + labs(tag="C") + theme(plot.tag = element_text(size=24, face = "bold")),
                                 hellinger + labs(tag = "D") + theme(plot.tag = element_text(size=24, face = "bold")) ,
                                 ncol = 2, align = 'h', axis="tblr", nrow=2)
global_figure <- gridExtra::arrangeGrob(upper_part,
                                        boxplot_parameter_bivariate +
                                          theme(plot.tag = element_text(size=24, face = "bold")) + labs(tag = "E"),
                                        top="", nrow = 2, heights = c(1.5, 1), padding = unit(1, "line"))
ggsave("figs/multivariate/multivariate_unbalanced_overlapping_positive_correlated.png",
       global_figure, width = 20, height = 24, dpi=75)

knitr::include_graphics("figs/multivariate/multivariate_unbalanced_overlapping_positive_correlated.png", dpi=75)


## ----compute-multivariate-overlapping-unbalanced-uncorrelated-----------------
specific_multivariate_parameters_local_scores <- multivariate_parameters_local_scores_summary %>%
  dplyr::filter(ID=="B15") %>% select(-ID)
nrow_summary <- nrow(specific_multivariate_parameters_local_scores)


## ----multivariate-overlapping-unbalanced-uncorrelated-pdf, eval=knitr::is_latex_output()----
specific_multivariate_parameters_local_scores_kable <- specific_multivariate_parameters_local_scores %>%
  kbl(booktabs=T, caption = "MSE and Bias associated to scenario B15, in Table \\ref{tab:parameter-configuration-bivariate}   (unbalanced, overlapping and uncorrelated components).", escape=F,
      col.names = linebreak(c("Package", "Initialisation\nMethod",
                              "Global \n MSE $p$", "Global\nMSE $\\mu$", "Global\nMSE $\\sigma$",
                              "Global \n Bias $p$", "Global\nBias $\\mu$", "Global\nBias $\\sigma$"))) %>%
  kable_styling(latex_options=c("hold_position", "scale_down"), full_width = T) %>%
  row_spec(0,bold=T, align = "c") %>%
  column_spec(column = 1:8, latex_valign = "m") %>%
  column_spec(1, bold = T) %>% collapse_rows(columns = 1, valign = "middle")


for (metric_col in metric_colnames) {
  # define col vector
  col_vector <- rep("black", nrow_summary); metric_vector <- specific_multivariate_parameters_local_scores %>% pull(metric_col)
  col_vector[which(metric_vector==min(metric_vector))] <- "green" # set minimal values to green
  col_vector[which(metric_vector==max(metric_vector))] <- "red" # set maximal values to red
  # set colours
  specific_multivariate_parameters_local_scores_kable <- specific_multivariate_parameters_local_scores_kable %>%
    column_spec(match(metric_col, names(specific_multivariate_parameters_local_scores)),color=col_vector)
}
specific_multivariate_parameters_local_scores_kable


## ----multivariate-overlapping-unbalanced-uncorrelated-html, eval=knitr::is_html_output(), layout = "l-body-outset"----
#> specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores %>% flextable() %>%
#>   set_caption(caption = "MSE and Bias associated to scenario B15, in Table [Table parameter in the bivariate setting](#tab:parameter-configuration-bivariate) (unbalanced, overlapping and uncorrelated components.)", html_escape = F)
#> 
#> for (metric_col in metric_colnames) {
#>   specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==min(`", metric_col, "`)")),color = "green")
#> 
#>   specific_multivariate_parameters_local_scores_flex <- specific_multivariate_parameters_local_scores_flex %>%
#>     flextable::color(j=metric_col, part = "body",
#>                      i = as.formula(paste0("~ `", metric_col, "`==max(`", metric_col, "`)")),color = "red")
#> }
#> 
#> specific_multivariate_parameters_local_scores_flex %>%
#>   flextable::compose(j="global_mse_p", part = "header", value = as_paragraph("Global MSE \U0070")) %>%
#>   flextable::compose(j="global_mse_mu", part = "header", value = as_paragraph("Global MSE \U03BC")) %>%
#>   # flextable::compose(j="global_mse_ sigma", part = "header", value = as_paragraph("Global_mse_ ", as_equation("\\sigma"))) %>%
#>   flextable::compose(j="global_mse_sigma", part = "header", value = as_paragraph("Global MSE \U03C3")) %>%
#>   flextable::compose(j="global_bias_p", part = "header", value = as_paragraph("Global Bias \U0070")) %>%
#>   flextable::compose(j="global_bias_mu", part = "header", value = as_paragraph("Global Bias \U03BC")) %>%
#>   flextable::compose(j="global_bias_sigma", part = "header", value = as_paragraph("Global Bias \U03C3")) %>%
#>   set_header_labels(package= "Package", `initialisation method`="Initialisation Method") %>%
#>   theme_vanilla() %>% align(align = "center", part = "header") %>%  # centre align header
#>   merge_v(j = "Package") %>%   flextable::autofit()
#> 


## ----multivariate-overlapping-unbalanced-uncorrelated, fig.cap=if (multivariate_html_ouput) html_caption_unbalanced_uncorrelated_multivariate else pdf_caption_unbalanced_uncorrelated_multivariate----
true_theta <- multivariate_configuration %>% filter(ID=="B15") %>% pull(true_parameters) %>% magrittr::extract2(1)

# generate plots
bivariate_density <- plot_bivariate_normal_density_distribution(true_theta=true_theta, n = 2000)
computation_time <- plot_time_computations(multivariate_time_computations %>% filter(ID == "B15"))
ellipse <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID == "B15"), true_theta)
hellinger <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID == "B15"), true_theta) +
  theme(axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4))
boxplot_parameter_bivariate <- plot_boxplots_parameters(formatted_multivariate_distribution_parameters %>% filter(ID == "B15"), true_theta) +
  theme(axis.text.x = ggtext::element_markdown(angle = 90, size = 12, hjust=0.5, vjust = 0.4))


# concatenate plots together
upper_part <- cowplot::plot_grid(bivariate_density + labs(tag="A") + theme(plot.tag = element_text(size=24, face = "bold")),
                                 ellipse + labs(tag="B") + theme(plot.tag = element_text(size=24, face = "bold"), legend.title = element_blank()),
                                 computation_time + labs(tag="C") + theme(plot.tag = element_text(size=24, face = "bold")),
                                 hellinger + labs(tag = "D") + theme(plot.tag = element_text(size=24, face = "bold")) ,
                                 ncol = 2, align = 'h', axis="tblr", nrow=2)
global_figure <- gridExtra::arrangeGrob(upper_part,
                                        boxplot_parameter_bivariate +
                                          theme(plot.tag = element_text(size=24, face = "bold")) + labs(tag = "E"),
                                        top="", nrow = 2, heights = c(1.5, 1), padding = unit(1, "line"))
ggsave("figs/multivariate/multivariate_unbalanced_uncorrelated.png",
       global_figure, width = 20, height = 24, dpi=75)

knitr::include_graphics("figs/multivariate/multivariate_unbalanced_uncorrelated.png", dpi=75)


## ----general-balanced-overlapping-multivariate, fig.cap=if (multivariate_html_ouput) html_balanced_overlapping_general_multivariate else pdf_balanced_overlapping_general_multivariate----
true_theta_v1 <- multivariate_configuration %>% filter(ID=="B1") %>% pull(true_parameters) %>% magrittr::extract2(1)
ellipse_v1 <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID=="B1"), true_theta_v1) +
  theme(legend.title = element_blank())
hellinger_v1 <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID=="B1"), true_theta_v1)

true_theta_v2 <- multivariate_configuration %>% filter(ID=="B2") %>% pull(true_parameters) %>% magrittr::extract2(1)
ellipse_v2 <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID=="B2"), true_theta_v2) +
  theme(legend.title = element_blank())
hellinger_v2 <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID=="B2"), true_theta_v2)

true_theta_v3 <- multivariate_configuration %>% filter(ID=="B5") %>% pull(true_parameters) %>% magrittr::extract2(1)
ellipse_v3 <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID=="B5"), true_theta_v3) +
  theme(legend.title = element_blank())
hellinger_v3 <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID=="B5"), true_theta_v3)

# concatenate all plots
global_figure <- gridExtra::arrangeGrob(grobs=list(ellipse_v1 + labs(tag="A") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    hellinger_v1 + labs(tag = "B") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    ellipse_v2 + labs(tag="C") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    hellinger_v2 + labs(tag = "D") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    ellipse_v3 + labs(tag="E") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    hellinger_v3 + labs(tag = "F") + theme(plot.tag = element_text(size=24, face = "bold"))),
                                    ncol = 2, nrow=3, widths = c(1.5, 1))
ggsave("figs/multivariate/multivariate_balanced_overlapping.png",
       global_figure, width = 20, height = 24,dpi=75)

knitr::include_graphics("figs/multivariate/multivariate_balanced_overlapping.png", dpi=75)


## ----general-balanced-well-separated-multivariate, fig.cap=if (multivariate_html_ouput) html_balanced_well_separated_general_multivariate else pdf_balanced_well_separated_general_multivariate----
true_theta_v1 <- multivariate_configuration %>% filter(ID=="B6") %>% pull(true_parameters) %>% magrittr::extract2(1)
ellipse_v1 <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID=="B6"), true_theta_v1) +
  theme(legend.title = element_blank())
hellinger_v1 <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID=="B6"), true_theta_v1)

true_theta_v2 <- multivariate_configuration %>% filter(ID=="B7") %>% pull(true_parameters) %>% magrittr::extract2(1)
ellipse_v2 <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID=="B7"), true_theta_v2) +
  theme(legend.title = element_blank())
hellinger_v2 <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID=="B7"), true_theta_v2)

true_theta_v3 <- multivariate_configuration %>% filter(ID=="B10") %>% pull(true_parameters) %>% magrittr::extract2(1)
ellipse_v3 <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID=="B10"), true_theta_v3) +
  theme(legend.title = element_blank())
hellinger_v3 <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID=="B10"), true_theta_v3)

# concatenate all plots
global_figure <- gridExtra::arrangeGrob(grobs=list(ellipse_v1 + labs(tag="A") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    hellinger_v1 + labs(tag = "B") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    ellipse_v2 + labs(tag="C") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    hellinger_v2 + labs(tag = "D") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    ellipse_v3 + labs(tag="E") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    hellinger_v3 + labs(tag = "F") + theme(plot.tag = element_text(size=24, face = "bold"))),
                                    ncol = 2, nrow=3, widths = c(1.5, 1))
ggsave("figs/multivariate/multivariate_balanced_well_separated.png",
       global_figure, width = 20, height = 24,dpi=75)

knitr::include_graphics("figs/multivariate/multivariate_balanced_well_separated.png", dpi=75)


## ----general-unbalanced-well-separated-multivariate, fig.cap=if (multivariate_html_ouput) html_unbalanced_well_separated_general_multivariate else pdf_unbalanced_well_separated_general_multivariate----
true_theta_v1 <- multivariate_configuration %>% filter(ID=="B16") %>% pull(true_parameters) %>% magrittr::extract2(1)
ellipse_v1 <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID=="B16"), true_theta_v1) +
  theme(legend.title = element_blank())
hellinger_v1 <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID=="B16"), true_theta_v1)

true_theta_v2 <- multivariate_configuration %>% filter(ID=="B17") %>% pull(true_parameters) %>% magrittr::extract2(1)
ellipse_v2 <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID=="B17"), true_theta_v2) +
  theme(legend.title = element_blank())
hellinger_v2 <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID=="B17"), true_theta_v2)

true_theta_v3 <- multivariate_configuration %>% filter(ID=="B20") %>% pull(true_parameters) %>% magrittr::extract2(1)
ellipse_v3 <- plot_ellipses_bivariate(multivariate_distribution_parameters %>% filter(ID=="B20"), true_theta_v3) +
  theme(legend.title = element_blank())
hellinger_v3 <- plot_Hellinger(formatted_multivariate_distribution_parameters %>% filter(ID=="B20"), true_theta_v3)

# concatenate all plots
global_figure <- gridExtra::arrangeGrob(grobs=list(ellipse_v1 + labs(tag="A") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    hellinger_v1 + labs(tag = "B") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    ellipse_v2 + labs(tag="C") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    hellinger_v2 + labs(tag = "D") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    ellipse_v3 + labs(tag="E") + theme(plot.tag = element_text(size=24, face = "bold")),
                                    hellinger_v3 + labs(tag = "F") + theme(plot.tag = element_text(size=24, face = "bold"))),
                                    ncol = 2, nrow=3, widths = c(1.5, 1))
ggsave("figs/multivariate/multivariate_unbalanced_well_separated.png",
       global_figure, width = 20, height = 24,dpi=75)

knitr::include_graphics("figs/multivariate/multivariate_unbalanced_well_separated.png", dpi=75)


## ----heatmap-all-correlation-plots-multivariate, fig.cap= if (multivariate_html_ouput) html_global_heatmap_multivariate else pdf_global_heatmap_multivariate----
multivariate_distribution_parameters <- readRDS("./tables/multivariate/bivariate_distributions.rds")%>%
  dplyr::group_by(ID, package, initialisation_method) %>%
  dplyr::mutate(N.bootstrap=dplyr::row_number()) %>% dplyr::ungroup()
multivariate_correlation_heatmaps <- plot_correlation_Heatmap(multivariate_distribution_parameters %>% filter(ID=="B11"))
multivariate_correlation_heatmaps <- gridExtra::arrangeGrob(grobs=multivariate_correlation_heatmaps %>%
                                                              purrr::map(~grid::grid.grabExpr(ComplexHeatmap::draw(.x))),
                                                            top="", ncol = 2)
ggsave("./figs/multivariate/heatmap_multivariate.png", multivariate_correlation_heatmaps, width = 10.5, height = 13.5,dpi = 75)
knitr::include_graphics("./figs/multivariate/heatmap_multivariate.png", dpi = 75)

